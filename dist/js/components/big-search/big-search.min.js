(bbn_resolve)=>{((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div :class="[componentClass, 'bbn-overlay', 'bbn-flex-height']">
   <div class="bbn-w-100 bbn-c bbn-lg bbn-vlpadded">
      <bbn-input :placeholder="placeholder"
                 :style="{width: '75%'}"
                 :focused="true"
                 type="search"
                 ref="input"
                 @keydown="keydown"
                 :nullable="isNullable"
                 autocomplete="off"
                 v-model="filterString"
                 :loading="isAjax && isLoading"
                 button-right="nf nf-fa-search"/>
   </div>
   <div class="bbn-flex-fill">
      <bbn-scroll>
         <bbn-list v-if="filteredTotal && !isDisabled && !readonly"
                  :element="$el"
                  ref="list"
                  :auto-hide="false"
                  :suggest="suggest"
                  :component="searchComponent"
                  :children="null"
                  @select="select"
                  :source-url="sourceUrl"
                  :source-action="sourceAction"
                  :source-text="sourceText"
                  source-value="hash"
                  uid="hash"
                  :pageable="filteredTotal > limit"
                  :pager-element="_self"
                  :source="filteredData"/>
      </bbn-scroll>
   </div>
  <input type="hidden"
         v-model="value"
         ref="element"
         :name="name">
</div>
`;script.setAttribute('id','bbn-tpl-component-big-search');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);let css=document.createElement('link');css.setAttribute('rel','stylesheet');css.setAttribute('href',bbn.vue.libURL+'dist/js/components/big-search/big-search.css');document.head.insertAdjacentElement('beforeend',css);((bbn,Vue)=>{"use strict";Vue.component('bbn-big-search',{mixins:[bbn.vue.basicComponent,bbn.vue.eventsComponent,bbn.vue.inputComponent,bbn.vue.resizerComponent,bbn.vue.listComponent,bbn.vue.keynavComponent,bbn.vue.urlComponent,bbn.vue.dropdownComponent],props:{filterselection:{default:false},filterable:{type:Boolean,default:true},autobind:{default:false},nullable:{default:false},minLength:{type:Number,default:1},leftIcon:{default:false},rightIcon:{default:'nf nf-fa-search'},minWidth:{default:'4.2rem'},maxWidth:{default:'100%'},delay:{type:Number,default:20},shortPlaceholder:{type:String,default:'?'},autohide:{type:[Boolean,Number],default:1500},sourceAction:{type:[String,Function],default:'action'},sourceUrl:{type:[String,Function],default:'url'},selectUrl:{type:String},searchFunctions:{type:Array,default(){return[];},validator(a){let ok=true;bbn.fn.each(a,f=>{if(!bbn.fn.isFunction(f)){ok=false;return false;}});return ok;}}},data(){return{isOpened:true,specialWidth:this.minWidth,currentPlaceholder:this.shortPlaceholder,timeout:null,mouseTimeout:null,registeredFunctions:this.searchFunctions.slice()};},computed:{isNullable(){return this.nullable&&this.isActive;},searchComponent(){let cp=bbn.fn.isString(this.component)||(bbn.fn.isObject(this.component)&&Object.keys(this.component).length)?this.component:null;if(!cp){cp={props:['source'],data(){return this.source;},template:`<component :is="myCp" :source="source"></component>`,computed:{myCp(){return this.source.component||'div';}}};}
bbn.fn.log(cp,this.source);return cp;},},methods:{registerFunction(fn){if(!bbn.fn.isFunction(fn)){throw new Error(bbn._("%s takes a function as argument","registerFunction"));}
let signature=bbn.fn.md5(fn.toString());if(!bbn.fn.getRow(this.registeredFunctions,{signature:signature})){this.registeredFunctions.push({signature:signature,fn:fn});}},unregisterFunction(fn){let idx=this.registeredFunctions.indexOf(fn);if(idx>-1){this.registeredFunctions.splice(idx,1);}},select(item,idx,dataIndex){if(!this.isDisabled){let ev=new Event('select',{cancelable:true});this.$emit('select',ev,item,idx,dataIndex);if(!ev.defaultPrevented){if(this.sourceAction&&item[this.sourceAction]){if(typeof(item[this.sourceAction])==='string'){if(bbn.fn.isFunction(this[item[this.sourceAction]])){this[item[this.sourceAction]]();}}
else if(bbn.fn.isFunction(item[this.sourceAction])){if(this.actionArguments){item[this.sourceAction](...this.actionArguments);}
else{item[this.sourceAction](idx,item.data);}}}
else if(this.sourceUrl&&item[this.sourceUrl]){let url=bbn.fn.isFunction(this.sourceUrl)?this.sourceUrl(item,idx,dataIndex):item[this.sourceUrl];if(url){bbn.fn.link(url);}}
if(this.selectUrl){bbn.fn.post(this.selectUrl,{data:item,id:this.searchId},d=>{bbn.fn.log("RESULT OF SELECT URL",d);})}
this.isOpened=false;this.filterString='';}}},keydown(e){if((e.key===' ')||this.commonKeydown(e)){return;}
if(e.key==='Escape'){this.isOpened=false;this.filterString='';}
else if(bbn.var.keys.upDown.includes(e.keyCode)){this.keynav(e);}},async updateData(){if(this.beforeUpdate()!==false){this._dataPromise=new Promise(resolve=>{let loadingRequestID;if(this.loadingRequestID){bbn.fn.abort(this.loadingRequestID);setTimeout(()=>{this.loadingRequestID=false;this.updateData().then(()=>{resolve();})},50);return;}
this.isLoading=true;this.$emit('startloading');let data=this.getData();loadingRequestID=bbn.fn.getRequestId(this.source,data);this.loadingRequestID=loadingRequestID;this.post(this.source,data).then(d=>{if(!this.loadingRequestID||(this.loadingRequestID!==loadingRequestID)){this.isLoading=false;this.loadingRequestID=false;throw new Error("No loading request");}
this.isLoading=false;this.loadingRequestID=false;if(!d){return;}
if(d.status!==200){d.data=undefined;}
else{d=d.data;}
this.$emit('datareceived',d);if(bbn.fn.isArray(d.data)){this.appendData(d.data);}
this.afterUpdate();resolve(this.currentData);if(!this.isLoaded){this.isLoaded=true;}
this.$emit('dataloaded',d);if(this.isAjax&&d&&d.next_step){if(d.id&&(d.data!==undefined)){this.searchId=d.id;}
this.getMoreData(d.next_step);}});}).catch(e=>{this.isLoading=false;this.loadingRequestID=false;bbn.fn.log("ERROR",e);});return this._dataPromise;}},appendData(data){bbn.fn.each(this.treatData(data),a=>{let todo=true;if(a.data.hash){let row=bbn.fn.filter(this.currentData,r=>r.data.hash===a.data.hash);if(row.length&&(row[0].data.score&&a.data.score)){todo=false;row[0].data.score+=a.data.score;}}
if(todo){this.currentData.push(a);}});bbn.fn.order(this.currentData,'data.score','desc');this.updateIndexes();},getMoreData(step=0){if(this.isAjax){this.isLoading=true;this.$emit('startloading');let data=this.getData();data.step=step;this.loadingRequestID=bbn.fn.getRequestId(this.source,data);this.isLoading=true;this.post(this.source,data,d=>{this.isLoading=false;this.loadingRequestID=false;if(d&&d.data){if(d.data.length){this.appendData(d.data);}
if(d.next_step){if(this.isOpened!==undefined){if(this.isOpened){bbn.fn.log("APPEING DATA")
this.getMoreData(d.next_step);}}
else{this.getMoreData(d.next_step);}}}});}},launchRegisteredFunctions(search){bbn.fn.each(this.registeredFunctions,o=>{let res=o.fn(search);if(bbn.fn.isArray(res)&&res.length){bbn.fn.each(res,r=>{let d=bbn.fn.extend({},r);delete d.score;if(!r.hash){r.hash=bbn.fn.md5(JSON.stringify(d));}
r.signature=o.signature;});this.appendData(res);}});}},watch:{isOpened(v){bbn.fn.log("isOpened",this.isOpened);if(!v){this.$emit('close');}},filterString(v){if(!this.ready){this.ready=true;}
clearTimeout(this.filterTimeout);if(v!==this.currentText){this.emitInput(v);this.$emit('change',v);if(this.currentData.length){this.currentData.splice(0);}
this.launchRegisteredFunctions(v);this.$nextTick(()=>{this.filterTimeout=setTimeout(()=>{this.filterTimeout=false;if(v&&(v.length>=this.minLength)){this.$once('dataloaded',()=>{this.$nextTick(()=>{let list=this.find('bbn-scroll');if(list){list.onResize();}});});this.currentFilters.conditions.splice(0,this.currentFilters.conditions.length?1:0,{field:this.sourceText,operator:'startswith',value:v});}
else{this.unfilter();}},this.delay);})}}},mounted(){this.ready=true;}});})(bbn,Vue);if(bbn_resolve){bbn_resolve("ok");}})(bbn);}