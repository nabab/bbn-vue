(bbn_resolve)=>{((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div :class="['bbn-overlay' , componentClass, {'bbn-unselectable': isSorting}]"
     @mouseleave="sortTargetIndex = null; isSorting = false"
     @touchend="isSorting = false"
     @dragend="isSorting = false"
     @mousemove="dragging"
     @mouseup="isSorting = false">
  <bbn-scroll :scrollable="scrollable"
              ref="scroll"
              v-bind="scrollable ? {axis: 'y'} : {}"
              @ready="onResize"
              :class="{
                'bbn-overlay': !scrollable
              }">
    <div :class="'bbn-masonry bbn-margin' + (sortable ? ' bbn-dashboard-sortable' : '')"
         ref="container"
         :style="{
              '-moz-column-count': numCols,
              '-webkit-column-count': numCols,
              'column-count': numCols
            }">
      <bbn-widget v-for="w in widgets"
                  :ref="'widget_' + w.key"
                  v-if="!w.hidden"
                  @loaded="resizeScroll"
                  v-bind="w"
                  :options="w.options"
                  :uid="w.key"
                  @close="hideWidget(w.key)"
                  :key="w.key"
                  :index="w.index"
                  @mouseenter="mouseEnterWidget(w.index)"
                  :class="{'bbn-selected-border': 
                    (sortOriginIndex !== w.index) && (
                      sortOriginIndex > w.index ?
                        (w.index === sortTargetIndex) :
                        (sortTargetIndex !== null) &&
                        (w.index - 1 === sortTargetIndex)
                    )
                  }"
                  @sortstart="isSorting = true; sortOriginIndex = w.index; sortTargetIndex = null"
                  :title="w.title ? w.title : (w.text ? w.text : '')"
      ></bbn-widget>
      <slot v-if="!widgets.length"></slot>
    </div>
    <div class="bbn-widget bbn-sort-helper"
         ref="sortHelper"
         :style="{
           display: isDragging ? 'block' : 'none',
           width: sortHelperWidth + 'px',
           height: sortHelperHeight + 'px',
           left: sortHelperX + 'px',
           top: sortHelperY + 'px'
         }"></div>
  </bbn-scroll>
</div>
`;script.setAttribute('id','bbn-tpl-component-dashboard');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);let css=document.createElement('link');css.setAttribute('rel','stylesheet');css.setAttribute('href',bbn.vue.libURL+'dist/js/components/dashboard/dashboard.css');document.head.insertAdjacentElement('beforeend',css);(function(bbn){"use strict";var limits=[5,10,15,20,25,30,40,50];Vue.component('bbn-dashboard',{mixins:[bbn.vue.basicComponent,bbn.vue.resizerComponent,bbn.vue.localStorageComponent],props:{components:{type:Object,default(){return{};}},max:{type:Number},selectable:{type:Boolean,default:true},closable:{type:Boolean,default:true},sortable:{type:Boolean,default:true},scrollable:{type:Boolean,default:true},source:{default(){return[];}},url:{},loadedConfig:{type:Object},order:{type:Array,default(){return[];}},cfg:{type:Object,default(){return{sortable:true,url:false,source:[],components:{}};}}},data(){return{originalSource:[],menu:[],isRefreshing:false,widgets:[],currentOrder:this.order.slice(),sortTargetIndex:null,sortOriginIndex:null,isSorting:false,isDragging:false,sortTimeout:false,sortingElement:false,sortHelperWidth:0,sortHelperHeight:0,sortHelperX:0,sortHelperY:0,currentSlots:[],resizeTimeout:false,numCols:1};},computed:{originalOrder(){return bbn.fn.map(this.originalSource,d=>d.key);},isOrderChanged(){if(!this.originalOrder){return false;}
return JSON.stringify(this.originalOrder)!==JSON.stringify(this.currentOrder);}},methods:{setConfig(uid,config){this.setStorage({order:config.order},uid);},closeWidget(uid,widget){bbn.fn.log('close',widget)
let ev=new Event('close',{cancelable:true});this.$emit('close',uid,widget);if(!ev.defaultPrevented){this.updateWidget(uid,{hidden:true});}},getWidget(key){let idx=bbn.fn.search(this.widgets,{key:key});if(idx>-1){return this.widgets[idx];}
return null;},hideWidget(key){return this.toggleWidget(key,true);},showWidget(key){return this.toggleWidget(key,false);},toggleWidget(key,hidden){if(this.widgets){let w=bbn.fn.getRow(this.widgets,{key:key});if(w&&(w.closable!==false)){this.updateWidget(key,{hidden:hidden===undefined?!w.hidden:hidden});}}},onResize(){let ele=this.getRef('container');if(ele){let actualWidth=parseInt(window.getComputedStyle(ele).width),num=1,steps=[800,1150,1550,2200,3000,3800];bbn.fn.each(steps,(step,i)=>{if(this.max&&(this.max<=num)){return false;}
if(actualWidth>=step){num++;}
else{return false;}});if(this.numCols!==num){this.numCols=num;}
this.resizeScroll();}},moveWidgets(oldIdx,newIdx){bbn.fn.move(this.widgets,oldIdx,newIdx);bbn.fn.each(this.widgets,(a,i)=>{if(i!==a.index){this.widgets[i].index=i;}});},move(oldIdx,newIdx){if(this.widgets[oldIdx]&&this.widgets[newIdx]){bbn.fn.move(this.widgets,oldIdx,newIdx);let order=[];bbn.fn.each(this.widgets,(a,i)=>{if(i!==a.index){a.index=i;}
order.push(a.key);});this.currentOrder=order;if(this.url){return this.post(this.url+'order',{order:order},d=>{if(d&&d.data&&d.data.success){appui.success();}
else{appui.error();}});}
this.$emit('sort',this.currentOrder);return true;}
return false;},updateMenu(){let tab=this.closest("bbn-container");if(tab){if(this.selectable&&this.menu&&this.menu.length){bbn.fn.each(this.menu,a=>{tab.deleteMenu(a);});}
this.menu=[];let items=[];let i=0;if(this.widgets){bbn.fn.log("THERE IS A MENU AND WIDGETS IN DASHBOARD");bbn.fn.each(this.originalSource,a=>{let w=bbn.fn.getRow(this.widgets,{uid:a.uid});if(w&&w.showable){items.push({disabled:!this.closable||(w.closable===false),selected:!w.hidden,text:w.text?w.text:(w.title?w.title:bbn._('Untitled')),action:()=>{this.toggleWidget(w.uid);}});i++;}});this.menu.push(tab.addMenu({text:bbn._("Widgets"),mode:'options',icon:'nf nf-mdi-widgets',items:items}));this.menu.push(tab.addMenu({text:bbn._("Show every widget"),icon:'nf nf-mdi-check_circle',action:()=>{bbn.fn.each(this.widgets,w=>{if(w.hidden){this.showWidget(w.uid);}});}}));this.menu.push(tab.addMenu({text:bbn._("Hide every widget"),icon:'nf nf-mdi-checkbox_blank_circle',action:()=>{bbn.fn.each(this.widgets,w=>{if(!w.hidden){this.hideWidget(w.uid);}});}}));if(this.isOrderChanged){this.menu.push(tab.addMenu({text:bbn._("Reset widgets order"),icon:'nf nf-fa-sort_numeric_asc',action:()=>{this.currentOrder.splice(0,this.currentOrder.length);this.initWidgets();this.$emit('sort',this.currentOrder);}}));}}}},mouseEnterWidget(idx){if(this.isSorting&&(idx!==this.sortOriginIndex)){this.sortTargetIndex=idx>this.sortOriginIndex?idx-1:idx;}
else if(this.sortTargetIndex!==null){this.sortTargetIndex=null;}},updateWidget(key,cfg){let idx=bbn.fn.search(this.widgets||[],'key',key),params={id:key,cfg:cfg},no_save=['items','num','start','index'];if(idx>-1){bbn.fn.each(no_save,function(a,i){if(cfg[a]!==undefined){delete params.cfg[a];}});if(bbn.fn.numProperties(params.cfg)){bbn.fn.iterate(params.cfg,(a,k)=>{if(this.widgets[idx][k]===undefined){this.$set(this.widgets[idx],k,a);}
else{this.widgets[idx][k]=a;}});this.$nextTick(()=>{this.setWidgetStorage(idx);if(params.cfg.hidden!==undefined){this.updateMenu();}
if(this.hasStorage){let cps=bbn.vue.findAll(this.$root,'bbn-dashboard');bbn.fn.each(cps,(cp,i)=>{if((cp!==this)&&(cp.storageFullName===this.storageFullName)){bbn.fn.iterate(params.cfg,(a,k)=>{if(cp.widgets[idx][k]===undefined){cp.$set(cp.widgets[idx],k,a);}
else if(cp.widgets[idx][k]!==a){cp.widgets[idx][k]=a;}});if(params.cfg.hidden!==undefined){cp.updateMenu();}}})}});if(this.url!==undefined){return this.post(this.url+'save',params,d=>{if(d&&d.data&&d.data.success){appui.success();}
else{appui.error();}});}
else{success();}}}
new Error("No corresponding widget found for key "+key);},getWidgetStorage(idx){if(this.widgets[idx]){this.getStorage(this.widgets[idx].storageFullName,true);}},setWidgetStorage(idx){this.setStorage({uid:this.widgets[idx].uid,hidden:this.widgets[idx].hidden,limit:this.widgets[idx].limit},this.widgets[idx].storageFullName,true);},normalize(obj_orig){let obj=obj_orig||{};obj.hidden=!!obj.hidden;if(!obj.key){obj.key=obj.uid?obj.uid:bbn.vue.makeUID();}
if(!obj.uid){obj.uid=obj.key;}
if(obj.showable===undefined){obj.showable=true;}
obj.storageFullName=(this.storageFullName||this._getStorageRealName())+'-'+obj.key;return obj;},add(obj,idx){let checkIdx=bbn.fn.search(this.widgets,{key:obj.key});if(checkIdx>-1){return this.widgets[checkIdx];}
if((idx===undefined)||(idx<0)||(idx>=this.widgets.length)){if(obj.hidden===undefined){obj.hidden=false;}
obj.index=this.widgets.length;this.widgets.push(obj);}
else if(idx<this.widgets.length){this.widgets.each(a=>{if(a.index>=idx){a.index++;}});obj.index=idx;this.widgets.splice(idx,0,obj);}
if(obj.storageFullName){let tmp=this.getWidgetStorage(idx);if(tmp){}}
return obj;},resizeScroll(){if(this.scrollable&&this.$refs.scroll){this.getRef('scroll').onResize();}},init(){this.originalSource=[];if(this.$slots.default){for(let node of this.$slots.default){if(node&&(node.tag==='bbns-widget')){this.originalSource.push(this.normalize(node.data.attrs));}}}
bbn.fn.each(this.source,(w,i)=>{this.originalSource.push(this.normalize(w));});this.initWidgets();this.updateMenu();},initWidgets(){this.widgets=[];bbn.fn.each(this.currentOrder,id=>{let w=bbn.fn.getRow(this.originalSource,{key:id});if(w){this.add(w);}})
bbn.fn.each(this.originalSource,(w,i)=>{if(this.currentOrder.indexOf(w.key)===-1){this.add(w);}});},setCurrentSlots(){this.currentSlots=this.$slots.default?this.$slots.default.filter(node=>{return!!node.tag;}):[];},dragging(e){if(this.isSorting){let w=e.clientX-Math.round(this.sortHelperWidth / 2);if(w<0){w=1;}
this.sortHelperX=w;this.sortHelperY=e.clientY+3;if(!this.isDragging){this.isDragging=true;}}}},created(){this.init();this.setCurrentSlots();},mounted(){this.ready=true;this.onResize();this.$watch('currentSlots',(newVal,oldVal)=>{if(!bbn.fn.isSame(newVal,oldVal)){this.init();}});},updated(){},watch:{sortTargetIndex(newVal){},isSorting(newVal){if(!newVal){if(this.sortable&&(this.sortOriginIndex!==this.sortTargetIndex)&&this.widgets[this.sortOriginIndex]&&this.widgets[this.sortTargetIndex]){let ev=new Event('move',{cancelable:true});this.$emit('move',ev,this.sortOriginIndex,this.sortTargetIndex);if(!ev.defaultPrevented){if(this.move(this.sortOriginIndex,this.sortTargetIndex)&&this.storageFullName){let cps=bbn.vue.findAll(this.$root,'bbn-dashboard');bbn.fn.each(cps,(cp,i)=>{if((cp!==this)&&(cp.storageFullName===this.storageFullName)){cp.move(this.sortOriginIndex,this.sortTargetIndex);}})}}}
this.sortTargetIndex=null;this.isDragging=false;}
else if(this.widgets[this.sortOriginIndex]){let w=this.widgets[this.sortOriginIndex];this.sortingElement=this.getRef('widget_'+w.key);let pos=this.sortingElement.$el.getBoundingClientRect();this.sortHelperWidth=pos.width;this.sortHelperHeight=pos.height;this.getRef('sortHelper').innerHTML=this.sortingElement.$el.innerHTML;}},source:{deep:true,handler(){this.init();}}}});})(bbn);if(bbn_resolve){bbn_resolve("ok");}})(bbn);}