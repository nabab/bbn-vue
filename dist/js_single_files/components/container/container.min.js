((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div :class="[componentClass, {
  'bbn-overlay': !visual && router.scrollContent,
  'bbn-w-100': !router.scrollContent
}]"
     @subready.stop
     :style="visual ? visualStyle : {}"
     v-show="(!router.isVisual && isVisible) || isVisualVisible || isPane">
  <div :class="{
    'bbn-overlay': router.scrollContent,
    'bbn-container-full-screen': fullScreen,
    'bbn-w-100': !router.scrollContent
  }">
    <transition name="fade"
                v-on:enter="enter"
                v-on:after-enter="onResize">
      <div :class="{
        'bbn-overlay': (isPane || !router.isVisual) && router.scrollContent,
        'bbn-flex-height': (!isPane && (router.isVisual || fullScreen)) && router.scrollContent,
        'bbn-w-100': visual || !router.scrollContent
      }"
          v-show="isVisible || router.isVisual">
        <!-- The header -->
        <div v-if="!isPane && (visual || fullScreen)"
            :class="'bbn-transition-bcolor bbn-b bbn-vspadded bbn-flex-width ' + (isVisible ? ' bbn-m' : '')"
            :style="{
              paddingLeft: '0.5rem',
              paddingRight: '0.5rem',
              fontSize: isVisible && !router.visualShowAll ? null : '10rem',
              backgroundColor: bcolor || router.bcolor,
              color: fcolor || router.fcolor
            }">
          <div class="bbn-flex-fill bbn-vmiddle">
            <bbn-context v-if="isVisible"
                        class="bbn-right-sspace bbn-lg bbn-p"
                        :floater-title="_('Container menu')"
                        tag="span"
                        :source="showMenu">
              <i class="nf nf-fa-bars"/>
            </bbn-context>
            <span v-if="icon"
                  class="bbn-right-sspace bbn-lg">
              <i :class="icon"/>
            </span>
            <span v-text="title"
                  style="overflow: hidden"/>
          </div>
          <!-- Icon for restoring size when in full screen mode -->
          <div v-if="isVisible && fullScreen"
              class="bbn-block bbn-p bbn-vmiddle bbn-h-100"
              @click="fullScreen = false">
            <i class="nf nf-mdi-arrow_collapse bbn-lg"/>
          </div>
          <!-- Icon for closing  -->
          <div v-else-if="isVisible && !isPane && !static && !pinned && !router.visualShowAll"
              class="bbn-block bbn-p bbn-vmiddle bbn-h-100"
              @click="close">
            <i class="nf nf-fa-times bbn-lg"/>
          </div>
        </div>
        <!-- The main container (the one we take screenshots of) -->
        <div :class="{
          'bbn-background': true,
          'bbn-overlay': !fullScreen && !router.isVisual && !isPane && router.scrollContent,
          'bbn-flex-fill': (fullScreen || (router.isVisual && !isPane)) && router.scrollContent,
          'bbn-w-100': !router.scrollContent,
          'bbn-container-visible': isVisible
        }"
            ref="canvasSource">
          <!-- The container's popup, from which each floater will come -->
          <bbn-popup ref="popup"
                    :source="popups"
                    v-if="ready"
                    v-show="!hidden && isLoaded && (isVisible || cached) && popups.length"/>
          <!-- This is shown when it's ready -->
          <bbn-scroll v-if="isLoaded && (isVisible || ((real || cached) && ready) || router.isVisual)"
                      v-show="ready && isVisible || (router.isVisual && !thumbnail)"
                      ref="scroll"
                      @ready="init"
                      :scrollable="scrollable && router.scrollContent"
                      axis="y"
                      :class="{
                        'bbn-overlay': router.scrollContent,
                        'bbn-w-100': !router.scrollContent
                      }">
            <!-- This is an ad hoc component with unique name -->
            <component v-if="isComponent"
                      :is="$options.components[componentName]"
                      :source="source"
                      ref="component"/>
            <!-- This is a classic component -->
            <component v-else-if="component"
                      :is="component"
                      :source="source"
                      ref="component"
                      v-bind="options"/>
            <!-- This is just HTML content -->
            <div v-else-if="content"
                 v-html="content">
            </div>
            <!-- This is the slot -->
            <slot v-else></slot>
            <!-- Adding style as a component -->
            <component is="style"
                      v-if="css"
                      scoped="scoped"
                      v-html="css"/>
          </bbn-scroll>
          <!-- If loading showing loader -->
          <div v-else-if="isVisible && errorStatus"
               class="bbn-overlay bbn-middle bbn-lg">
            <div class="bbn-lpadded bbn-state-error bbn-block bbn-nowrap">
              <h1 v-text="errorStatus.status"/>
              <div v-text="url"/>
              <div class="bbn-vlpadded bbn-b"
                   v-text="errorStatus.statusText"/>
              <div class="bbn-c">
                <bbn-button @click="close"
                            icon="nf nf-fa-times"
                            :text="_('Close')"
                            class="bbn-state-error"/>
              </div>
            </div>
          </div>
          <!-- If loading showing loader -->
          <bbn-loader v-else-if="isVisible && !isLoaded"/>
          <!-- Thumbnail image -->
          <div v-if="!isVisible && visual && thumbnail"
              style="overflow: hidden"
              class="bbn-overlay">
            <img :src="thumbnail"
                style="width: 100%; max-height: 100%; height: auto">
          </div>
        </div>
      </div>
    </transition>
    <!-- When in visual mode a layer prevents interaction with the content -->
    <div v-if="router.isVisual && (!isVisible || router.visualShowAll) && !isPane"
        class="bbn-overlay"
        style="z-index: 12; background-color: black; opacity: 0.2;">
    </div>
    <!-- When in visual mode this is the interaction layer -->
    <div v-if="router.isVisual && (!isVisible || router.visualShowAll)"
        class="bbn-overlay"
        @click="router.activateIndex(currentIndex)"
        @mouseenter="isOver = true"
        @mouseleave="isOver = false"
        style="z-index: 12">
      <transition name="fade">
        <div class="bbn-bottom-left bbn-w-100"
            v-show="isOver"
            :style="{
                fontSize: isVisible && !router.visualShowAll ? null : '10rem'
              }">
          <!-- Semi-transparent dark layer these buttons are not used -->
          <div class="bbn-bottom-left bbn-w-100 bbn-bg-black"
               style="opacity: 0.6; color: transparent">
            <div class="bbn-w-50 bbn-spadded">
              <!--span class="bbn-spadded bbn-p">
                <i class="nf nf-fa-bars"/>
              </span-->
            </div>
            <div class="bbn-w-50 bbn-right bbn-spadded">
              <span class="bbn-spadded bbn-p"
                    v-if="!pinned && !static">
                <i class="nf nf-fa-times"/>
              </span>
              <span class="bbn-spadded bbn-p"
                    v-else-if="pinned">
                <i class="nf nf-mdi-pin"/>
              </span>
              <span class="bbn-spadded bbn-p">
                <i class="nf nf-oct-pin"/>
              </span>
            </div>
          </div>
          <!-- These buttons are the real ones (white) -->
          <div class="bbn-bottom-left bbn-w-100 bbn-white">
            <div class="bbn-w-50 bbn-spadded">
              &nbsp;
              <!--bbn-context class="bbn-spadded bbn-iblock bbn-p"
                           tag="span"
                           :source="showMenu">
                <i class="nf nf-fa-bars"
                   @click.stop="pin"/>
              </bbn-context-->
            </div>
            <div class="bbn-w-50 bbn-right bbn-spadded">
              <span v-if="!pinned && !static"
                    @click.stop="pin"
                    class="bbn-spadded bbn-p">
                <i class="nf nf-oct-pin"/>
              </span>
              <span class="bbn-spadded bbn-p"
                    @click.stop="close"
                    v-if="!pinned && !static">
                <i class="nf nf-fa-times"/>
              </span>
              <span class="bbn-spadded bbn-p"
                    @click.stop="unpin"
                    v-else-if="pinned && !static">
                <i class="nf nf-mdi-pin_off"/>
              </span>
              &nbsp;
            </div>
          </div>
        </div>
      </transition>
    </div>
  </div>
</div>
`;script.setAttribute('id','bbn-tpl-component-container');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);(function(bbn,Vue){"use strict";let componentsList=[];Vue.component("bbn-container",{name:'bbn-container',mixins:[bbn.vue.basicComponent,bbn.vue.resizerComponent,bbn.vue.viewComponent,bbn.vue.observerComponent],props:{idx:{type:Number},last:{type:Number},uid:{type:String,default(){return bbn.fn.randomString();}},visual:{type:Boolean,default:false},screenshotDelay:{type:Number,default:43200000}},data(){return{router:null,dirty:false,isComponent:null,fullScreen:false,componentName:this.randomName(),popups:[],routers:{},currentScreenshotDelay:this.screenshotDelay,isComponentActive:false,isLoaded:!this.load||this.loaded,isPinned:this.pinned,isStatic:this.static,currentURL:this.current||this.url,isOver:false,_bbn_container:null,thumbnail:false,forms:[],errorStatus:null,currentTitle:this.title,currentIcon:this.icon,currentIndex:this.idx};},computed:{isPane(){return!!this.currentView.pane;},currentView(){if(this.router){return bbn.fn.getRow(this.router.views,{idx:this.currentIndex})}
return{};},isVisible(){if(this.router){if(this.isPane){if(!this.router.routed){return false;}
if(this.isLoaded){return true;}
let pane=bbn.fn.getRow(this.router.currentPanes,{id:this.currentView.pane});if(pane){let idx=bbn.fn.search(pane.tabs,{url:this.currentView.url});if(pane.tabs[idx]){return idx===pane.selected;}}
return(this.router.routed&&this.isPane)||(this.router.selected===this.currentIndex);}
else{return this.router.selected===this.currentIndex;}}
return false;},isVisualVisible(){if(this.router.isVisual){let row=bbn.fn.getRow(this.router.visualList,'view.idx',this.currentIndex);if(row){return row.visible;}}
return false;},visualStyle(){let r=this.router;if(r&&r.isVisual){if((r.numVisualReals>0)&&(!this.isVisible||r.visualShowAll)&&(!this.ready||!this.isPane)){return{zoom:0.1,width:'100%',height:'auto',overflow:'hidden'};}
let coord=[1,r.numVisualCols+1,1,r.numVisualRows+1];if(r.numVisualReals>0){switch(r.visualOrientation){case'top':coord[2]=2;break;case'bottom':coord[3]=coord[3]-1;break;case'left':coord[0]=2;break;case'right':coord[1]=coord[1]-1;break;}}
return{gridColumnStart:coord[0],gridColumnEnd:coord[1],gridRowStart:coord[2],gridRowEnd:coord[3],zoom:1};}
return{};},anonymousComponent(){return this.$refs.component;}},methods:{getFullCurrentURL(){return this.router.getFullBaseURL()+this.currentURL;},getFullURL(){return this.router.getFullBaseURL()+this.url;},setLoaded(val){this.isLoaded=!!val;},randomName(){let n=bbn.fn.randomString(20,15).toLowerCase();while(componentsList.indexOf(n)>-1){n=bbn.fn.randomString(20,15).toLowerCase();}
return n;},show(){if(!this.isPane){this.router.selected=this.currentIndex;if(this.visual&&this.router.visualShowAll){this.router.visualShowAll=false;}}},close(){if(!this.isPane){this.router.close(this.currentIndex);}},setCurrent(url){if(url.indexOf(this.url)===0){this.currentURL=url;return true;}
return false;},setTitle(title){if(this.router){if(!this.real){this.router.views[this.currentIndex].title=title;}
else{this.currentTitle=title;}}},setIcon(icon){if(this.router){if(!this.real){this.router.views[this.currentIndex].icon=icon;}
else{this.currentIcon=icon;}}},setColor(bcolor,fcolor){if(this.router){let view=this.router.getView(this.url);if(view){if(bcolor){this.router.$set(view,"bcolor",bcolor);}
if(fcolor){this.router.$set(view,"fcolor",fcolor);}}}},popup(){let popup=this.getPopup();return arguments.length?popup.open.apply(popup,arguments):popup;},getComponent(){return this.getRef('component');},enter(){this.router.enter(this);},pin(){this.router.pin(this.currentIndex);},unpin(){this.router.unpin(this.currentIndex);},reload(){this.router.reload(this.currentIndex);},addMenu(obj){if((this.currentIndex>-1)&&obj.text&&this.router.views&&this.router.views[this.currentIndex]){if(this.router.views[this.currentIndex].menu===undefined){this.router.views[this.currentIndex].menu=[];}
let menu=this.router.views[this.currentIndex].menu||[],idx=bbn.fn.isFunction(menu)?-1:bbn.fn.search(menu||[],{text:obj.text});if(idx===-1){if(bbn.fn.isFunction(menu)){this.router.views[this.currentIndex].menu=()=>{let items=menu()||[];if(bbn.fn.search(items,obj)===-1){if(!obj.key){obj.key=bbn.fn.randomInt(99999,99999999999);}
items.push(obj);}
return items;};}
else{if(!obj.key){obj.key=bbn.fn.randomInt(99999,99999999999);}
menu.push(obj);}}
else{obj.key=menu[idx].key;menu.splice(idx,1,obj);}
this.router.views[this.currentIndex].menu=menu;return obj.key;}
return false;},deleteMenu(key){if((this.currentIndex>-1)&&this.router.views&&this.router.views[this.currentIndex]){let menu=this.router.views[this.currentIndex].menu||[];if(bbn.fn.isFunction(menu)){menu=()=>{let items=menu()||[];let idx=bbn.fn.search(items,"key",key);if(idx>-1){items.splice(idx,1);this.router.views[this.currentIndex].menu=items;this.router.$forceUpdate();return true;}};}
else{let idx=bbn.fn.search(menu,"key",key);if(idx>-1){menu.splice(idx,1);this.router.views[this.currentIndex].menu=menu;this.router.$forceUpdate();return true;}}}
return false;},onResize(){if(this.isVisible&&this.ready){bbn.vue.resizerComponent.methods.onResize.apply(this,arguments);}},init(){if(this.isPane){}
if(this.isVisible&&(this.real||(this.isLoaded&&!this.ready))){let res;if(this.currentView.script){res=typeof this.currentView.script==='string'?eval(this.currentView.script):this.currentView.script;if(bbn.fn.isFunction(res)){this.onMount=res;this.isComponent=false;}
else if(res&&(typeof(res)==='object')){this.isComponent=true;}}
else if(this.content){this.isComponent=false;}
if(this.isComponent){let cont=this;let o=bbn.fn.extend(true,res?res:{},{template:'<div class="'+(this.router.scrollContent?'':'bbn-w-100')+'">'+this.currentView.content+'</div>',methods:{getContainer(){if(!this._bbn_container){this._bbn_container=this.closest('bbn-container');}
return this._bbn_container;},getTab(){return this.getContainer();},addMenu(){return this.getContainer().addMenu.apply(this.router,arguments)},deleteMenu(){return this.getContainer().deleteMenu.apply(this.router,arguments)}},props:['source']});this.$options.components[this.componentName]=o;}
else{this.isComponent=false;}
setTimeout(()=>{if(bbn.env.url.indexOf('#')){let scroll=this.getRef('scroll');if(scroll&&(scroll.currentY||scroll.currentX)){return;}
let hash=bbn.env.url.split('#')[1];if(hash){hash='#'+hash;location.hash=null;location.hash=hash;}}},2000);if(this.visual){this.setScreenshot();}
this.ready=true;}},showMenu(){return this.router.getMenuFn(this.currentIndex);},setScreenshot(){if(!this._screenshotInterval&&this.router.isVisual&&this.router.db&&!this.isPane){let url=this.getFullURL();this.router.db.selectOne('containers','time',{url:url}).then(time=>{if((bbn.fn.timestamp()-(time||0))>=this.currentScreenshotDelay){this.saveScreenshot(0.1,10000);}}).catch(()=>{this.saveScreenshot(0.1,10000);});this._screenshotInterval=setInterval(()=>{this.saveScreenshot(0.1);},this.currentScreenshotDelay);}},unsetScreenshot(){if(this._screenshotInterval){clearInterval(this._screenshotInterval);this._screenshotInterval=false;if(this._screenshotTimeout){clearTimeout(this._screenshotTimeout);this._screenshotTimeout=false;}}},async saveScreenshot(scale=0.1,timeout=0){if(this.router.db&&(this.currentView.idx===this.router.selected)&&!this.isPane){let img=await this.takeScreenshot(scale,timeout,true);let num_tries=0;while(!img&&(num_tries<5)){num_tries++;img=await this.takeScreenshot(scale,5000);}
if(!img){bbn.fn.log(bbn._("Impossible to take the screenshot of")+' '+this.getFullCurrentURL());return;}
this.thumbnail=img.src;this.router.db.insert('containers',{url:this.getFullURL(),image:img.src,time:bbn.fn.timestamp()});}},takeScreenshot(scale=1,timeout=0,image=false,force=false){return new Promise(resolve=>{if(this._screenshotTimeout){if(force){clearTimeout(this._screenshotTimeout);}
else{resolve(false);}}
this._screenshotTimeout=setTimeout(()=>{let exit=()=>{this._screenshotTimeout=false;resolve(false);};if((this.currentIndex===this.router.selected)&&this.isVisible&&window.html2canvas&&bbn.fn.isActiveInterface(600)&&!this.router.visualShowAll){let scroll=this.getRef('scroll');if(!scroll){return exit();}
if(scroll.$el){scroll=scroll.$el;}
let w=scroll.clientWidth;let h=scroll.clientHeight;let s=Math.min(w,h);let ct=this.getRef('canvasSource');if(!ct||!s){return exit();}
ct.style.width=s+'px !important';ct.style.height=s+'px !important';html2canvas(ct,{width:s,height:s,scale:scale}).then(canvas=>{ct.style.width=null;ct.style.height=null;this._screenshotTimeout=false;if(!image){resolve(canvas);return;}
let img=bbn.fn.canvasToImage(canvas);let ctx=canvas.getContext('2d');let size=Math.min(canvas.width,canvas.height);let num=Math.min(this.router.numVisualCols,this.router.numVisualRows);let msize=Math.ceil(size / num);ctx.drawImage(img,0,0,size,size,0,0,msize,msize);resolve(img);});}
else{exit();}},timeout)})},updateScreenshot(){if(this.visual&&this.router.db){let url=this.getFullURL();this.router.db.selectOne('containers','image',{url:url}).then(res=>{if(res){this.thumbnail=res;}});}},registerRouter(router){this.routers[bbn.fn.substr(router.getBaseURL(),0,-1)]=router;this.router.registerRouter(router);},unregisterRouter(router){delete this.routers[bbn.fn.substr(router.getBaseURL(),0,-1)];this.router.unregisterRouter(router);},},created(){this.componentClass.push('bbn-resize-emitter');if(this.isComponent){componentsList.push(this.componentName);}
else if(this.isComponent===null){this.onMount=()=>{return false;};let res;}
this.router=this.closest('bbn-router');this.updateScreenshot()
this._screenshotInterval=false;},mounted(){if(!this.router){throw new Error(bbn._("bbn-container cannot be rendered without a bbn-router"));}
if(!this.router.ready){this.router.$on('ready',()=>{});}
else{this.router.register(this);}},beforeDestroy(){this.router.unregister(this);if(this.isComponent){let idx=componentsList.indexOf(this.componentName);if(idx>-1){componentsList.splice(idx,1);}}},watch:{title(v){this.currentTitle=v;},icon(v){this.currentIcon=v;},loaded(v){this.isLoaded=v;},loading(v){this.isLoading=v;},idx(v){if(this.visual){this.isOver=false;}
this.currentIndex=v;},current(newVal){if(newVal.indexOf(this.url)===0){this.currentURL=newVal;}},currentURL(newVal,oldVal){if(!newVal||(newVal.indexOf(this.url)!==0)){this.currentURL=this.url;}},ready(v){if(v){if(this.onMount){this.onMount(this.$el,this.source);}}},isVisible(nv){let emit=true;if(!this.isPane&&this.router.isVisual){if(nv){this.setScreenshot()}
else{this.unsetScreenshot();}}
if(emit){this.$emit(nv?'view':'unview',this);}
if(nv){if(!this.isLoaded&&!this.isLoading){this.router.load(this.currentURL,true)}
this.$nextTick(()=>{this.onResize();});}},content(newVal,oldVal){if(newVal){this.isComponentActive=false;}},fullScreen(newVal){let fn=e=>{if(e.keyCode===27){this.fullScreen=false;}};if(newVal){document.body.addEventListener('keydown',fn);}
else{document.body.removeEventListener('keydown',fn);}
this.$nextTick(()=>{this.selfEmit(true)})},dirty(v){let view=this.router.getView(this.url);if(view){view.dirty=v;this.router.retrieveDirtyContainers();}}},});})(bbn,Vue);})(bbn);