((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div :class="[componentClass, {
             'bbn-invisible': !ready,
             'bbn-overlay': (nav || scrollContent),
             'bbn-w-100': !scrollContent
             }]">
  <bbn-splitter :resizable="resizable"
                :collapsible="collapsible"
                :full-size="scrollContent">
    <bbn-pane :scrollable="false">
      <div :class="{
                  'bbn-overlay': scrollContent,
                  'bbn-flex-height': scrollContent,
                  'bbn-router-nav': nav,
                  'bbn-router-nav-bc': nav && isBreadcrumb,
                  'bbn-w-100': !scrollContent
                  }">
        <!-- START OF BREADCRUMB -->
        <div v-if="nav && isBreadcrumb && !isVisual"
            ref="breadcrumb"
            :class="['bbn-router-breadcrumb', {'bbn-router-breadcrumb-master': master}]">
          <div v-if="master"
              class="bbn-router-breadcrumb-container">
            <div class="bbn-transition-bcolor bbn-h-100 bbn-alt bbn-bordered-bottom bbn-no-border-top bbn-no-border-right bbn-vmiddle"
                :style="{
                        backgroundColor: getBackgroundColor(selected),
                        color: getFontColor(selected)
                        }">
              <div class="bbn-flex-width bbn-h-100 bbn-vmiddle">
                <template v-if="breadcrumbs.length"
                          v-for="(bc, i) in breadcrumbs">
                  <div v-if="i > 0">
                    <i class="nf nf-fa-angle_right bbn-hsmargin bbn-large bbn-router-breadcrumb-arrow"/>
                  </div>
                  <bbn-context :source="bc.getList(i)"
                              tag="div"
                              min-width="10em"
                              tabindex="0"
                              :item-component="$options.components.listItem"
                              class="bbn-h-100 bbn-vmiddle"
                              :attach="itsMaster ? (itsMaster.getRef('breadcrumb') || undefined) : undefined"
                              :autobind="false"
                              :style="{
                                      backgroundColor: bc.getBackgroundColor(bc.selected),
                                      color: bc.getFontColor(bc.selected)
                                      }">
                    <bbn-context :source="bc.getMenuFn"
                                :source-index="isNumber(bc.selected) ? bc.selected : undefined"
                                tag="div"
                                min-width="10em"
                                tabindex="0"
                                :context="true"
                                :autobind="false"
                                class="bbn-vmiddle bbn-h-100">
                      <div class="bbn-vmiddle bbn-h-100">
                        <div class="bbn-router-breadcrumb-badge-container bbn-middle"
                            v-if="isNumber(bc.selected) && bc.views[bc.selected] && numProperties(bc.views[bc.selected].events)">
                          <span class="bbn-badge bbn-small bbn-bg-red"
                                v-text="numProperties(bc.views[bc.selected].events)"/>
                        </div>
                        <div class="bbn-router-breadcrumb-loader bbn-border-text"
                            :style="{borderColor: isNumber(bc.selected) && bc.views[bc.selected] && bc.views[bc.selected].fcolor ? bc.views[bc.selected].fcolor : null}"
                            v-show="isNumber(bc.selected) && bc.views[bc.selected] && bc.views[bc.selected].loading"/>
                        <div :class="[
                                    'bbn-router-breadcrumb-element',
                                    'bbn-h-100',
                                    'bbn-vmiddle',
                                    {
                                    'bbn-router-breadcrumb-dirty': isNumber(bc.selected)
                                    && bc.views[bc.selected]
                                    && !!bc.views[bc.selected].dirty
                                    }
                                    ]">
                          <span v-if="isNumber(bc.selected) && bc.views[bc.selected] && bc.views[bc.selected].icon"
                                :title="bc.views[bc.selected].title"
                                :class="'bbn-router-breadcrumb-element-icon bbn-h-100 bbn-vmiddle bbn-right-xsspace' + (bc.views[bc.selected].notext ? ' bbn-lg' : ' bbn-m')">
                            <i :class="bc.views[bc.selected].icon"/>
                          </span>
                          <span v-if="isNumber(bc.selected) && bc.views[bc.selected] && !bc.views[bc.selected].notext"
                                :class="['bbn-router-breadcrumb-element-text', {'bbn-b': !breadcrumbs[i+1]}]"
                                :title="bc.views[bc.selected].title && (bc.views[bc.selected].title.length > bc.maxTitleLength) ? bc.views[bc.selected].title : ''"
                                v-html="bc.views[bc.selected].title ? bc.cutTitle(bc.views[bc.selected].title) : _('Untitled')"/>
                        </div>
                        <i v-if="isNumber(bc.selected)
                                && bc.views[bc.selected]
                                && !bc.views[bc.selected].static
                                && !bc.views[bc.selected].pinned"
                          class="nf nf-fa-times bbn-p bbn-router-breadcrumb-close bbn-router-breadcrumb-icon"
                          @click.prevent.stop="bc.close(bc.selected)"/>
                        <bbn-context v-if="isNumber(bc.selected) && bc.views[bc.selected] && bc.views[bc.selected].menu"
                                    :source="() => bc.getMenuFn(bc.selected)"
                                    tag="i"
                                    class="nf nf-fa-caret_down bbn-router-breadcrumb-icon bbn-router-breadcrumb-menu"/>
                      </div>
                    </bbn-context>
                  </bbn-context>
                </template>
                <div v-if="breadcrumbs.length"
                    class="bbn-flex-fill bbn-h-100"
                    :style="{
                            backgroundColor: breadcrumbs[breadcrumbs.length-1].getBackgroundColor(breadcrumbs[breadcrumbs.length-1].selected),
                            color: breadcrumbs[breadcrumbs.length-1].getFontColor(breadcrumbs[breadcrumbs.length-1].selected)
                            }">
                  &nbsp;
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- END OF BREADCRUMB -->
        <!-- START OF TABS -->
        <bbn-tabs v-else-if="nav && !isBreadcrumb && !isVisual"
                  ref="tabs"
                  v-model="selectedTab"
                  @close="closeTab"
                  :scrollable="scrollable"
                  :max-title-length="maxTitleLength"
                  :source="tabsList"/>
        <!-- END OF TABS -->
        <!-- START OF CONTENT -->
        <div v-if="ready"
            :class="{
                    'bbn-router-scroller': isVisual,
                    'bbn-flex-fill': scrollContent,
                    'bbn-w-100': !scrollContent
                    }"
            style="overflow: auto;"
            ref="visualListContainer">
          <div :class="{
                      'bbn-overlay': !isVisual && scrollContent,
                      'bbn-100': isVisual && scrollContent && !visualShowAll,
                      'bbn-w-100': isVisual && !scrollContent || visualShowAll,
                      'bbn-router-visual': isVisual
                    }"
              :style="isVisual ? visualStyle : {}"
              ref="visualRouter"
              @keydown.esc="onEscape"
              :tabindex="isVisual && visualShowAll ? 0 : -1">
            <div v-if="isVisual && (selected !== null) && (views.length > numVisuals)"
                class="bbn-bg-black bbn-white bbn-p"
                @click="visualShowAll = !visualShowAll">
              <div class="bbn-100 bbn-middle">
                <div class="bbn-block bbn-xxxl">
                  <i :class="'nf nf-fa-' + (visualShowAll ? 'minus' : 'plus')"/>
                </div>
              </div>
            </div>
            <slot></slot>
            <bbn-portal v-for="a in isVisual ? visualList : views"
                        :key="isVisual ? a.view.uid : (component && componentSource && componentUrl ? componentSource[componentUrl] : a.uid)"
                        :disabled="!routed || !getPane(a)"
                        :selector="getPane(a) ? '#' + getPane(a) + slashToHyphen(isVisual ? a.view.url : a.url) : null">
              <bbn-container v-if="(isVisual ? !a.view.real : !a.real) && !component"
                            :key="isVisual ? a.view.uid : a.uid"
                            :visual="isVisual"
                            v-bind="isVisual ? a.view : a"/>
              <bbn-container v-else-if="component && componentSource && componentUrl"
                            :source="componentSource"
                            :visual="isVisual"
                            :component="component"
                            :key="componentSource[componentUrl]"
                            :url="componentSource[componentUrl]"/>
            </bbn-portal>
          </div>
        </div>
        <!-- END OF CONTENT -->
        <bbn-loader v-else/>
        <bbn-scrollbar :container="$refs.visualListContainer"
                       orientation="vertical"
                       v-if="isVisual && visualShowAll"/>
      </div>
    </bbn-pane>
    <!-- START FOR SPLITTABLE MODE -->
    <bbn-pane v-if="!single && splittable && currentPanes.length"
              :scrollable="false"
              size="30%">
      <bbn-splitter :resizable="resizable"
                    :collapsible="collapsible"
                    ref="splitter">
        <bbn-pane v-for="(pane, i) in currentPanes"
                  :key="i"
                  :ref="'pane' + pane.id"
                  :title="pane.tabs[pane.selected] ? pane.tabs[pane.selected].title : null"
                  :size="i ? Math.floor(100/currentPanes.length) + '%' : null"
                  :scrollable="false">
          <div class="bbn-overlay bbn-flex-height bbn-router-nav">
            <!-- PANE TABS -->
            <bbn-tabs :scrollable="true"
                      :source="pane.tabs"
                      :closable="false"
                      v-model="pane.selected"
                      :limit="5"/>
            <!-- PANE CONTENT -->
            <div class="bbn-flex-fill">
              <div v-for="(tab, tabIndex) in pane.tabs"
                   class="bbn-overlay"
                   v-show="pane.selected === tabIndex"
                   :id="pane.id + slashToHyphen(tab.url)"/>
            </div>
          </div>
        </bbn-pane>
      </bbn-splitter>

    </bbn-pane>
  </bbn-splitter>
  <bbn-floater v-if="!single && showRouterCfg"
               :modal="true"
               :title="false"
               width="100%"
               :closable="false"
               ref="cfgwindow"
               height="100%">
    <div class="bbn-overlay bbn-middle"
         @click="showRouterCfg = false">
      <div class="bbn-block bbn-background"
           @click.stop>
        <bbn-router-config :router="this"/>
      </div>
    </div>
  </bbn-floater>
</div>`;script.setAttribute('id','bbn-tpl-component-router');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);(function(bbn,Vue){"use strict";const possibleOrientations=[{name:'auto',text:bbn._("Position automatically")},{name:'left',text:bbn._("Position on the left side")},{name:'top',text:bbn._("Position on the top side")},{name:'bottom',text:bbn._("Position on the bottom side")},{name:'right',text:bbn._("Position on the right side")}];let db=false;if(bbn.db&&bbn.db.ok&&window.html2canvas){db=true;if(!bbn.db._structures.bbn||!bbn.db._structures.bbn.containers){bbn.db.add('bbn','containers',{keys:{PRIMARY:{columns:['url'],unique:true}},fields:{url:{},image:{}}});}}
Vue.component("bbn-router",{name:'bbn-router',mixins:[bbn.vue.basicComponent,bbn.vue.localStorageComponent,bbn.vue.closeComponent,bbn.vue.observerComponent,bbn.vue.resizerComponent,bbn.vue.keepCoolComponent],props:{auto:{type:Boolean,default:true},url:{type:String,default:''},autoload:{type:Boolean,default:true},root:{type:String,default:''},def:{type:String},source:{type:Array,default(){return[];}},single:{type:Boolean,default:false},maxTotal:{type:Number,default:25},nav:{type:Boolean,default:false},visual:{type:Boolean,default:false},scrollable:{type:Boolean,default:false},scrollContent:{type:Boolean,default:true},storageName:{type:String,default:'__ROOT__'},confirmLeave:{type:[Boolean,String,Function],default:bbn._("Are you sure you want to discard the changes you made in this page?")},historyMaxLength:{type:Number,default:10},menu:{type:[Array,Function],default:function(){return[];}},breadcrumb:{type:Boolean,default:false},master:{type:Boolean,default:false},postBaseUrl:{type:Boolean,default:true},component:{type:[String,Object]},componentSource:{type:Object},componentUrl:{type:String},maxTitleLength:{type:Number,default:20},urlNavigation:{type:Boolean,default:true},ignoreDirty:{type:Boolean,default:false},visualSize:{type:Number,default:150},orientation:{type:String,default(){return'auto'},validator(v){return!!bbn.fn.getRow(possibleOrientations,{name:v})}},bcolor:{type:String,default:'#666'},fcolor:{type:String,default:'#EEE'},panes:{type:Array,default(){return[]}},first:{type:String,default:'real'},splittable:{type:Boolean,default:false},collapsible:{type:Boolean,default:true},resizable:{type:Boolean,default:true}},data(){return{db:null,numRegistered:0,hasRealContainers:false,hasFakeContainers:false,hasEmptyURL:false,cfgViews:[].concat(this.source),slotViews:[],views:[],urls:{},currentTitle:'',currentURL:this.url||'',baseURL:this.formatBaseURL(this.root),parents:[],routers:{},parent:null,router:null,parentContainer:null,visible:true,activeContainer:null,isLoading:false,routed:false,isRouting:false,isInit:false,selected:null,dirtyContainers:[],history:[],iconsReady:false,isBreadcrumb:this.breadcrumb,breadcrumbWatcher:false,breadcrumbsList:[],visualShowAll:false,visualOrientation:this.orientation!=='auto'?this.orientation:null,lockedOrientation:false,isVisual:this.visual,currentPanes:this.panes.slice(),showRouterCfg:false};},computed:{selectedTab:{get(){return bbn.fn.search(this.tabsList,{idx:this.selected})},set(v){this.selected=this.tabsList[v].idx;}},isSplittable(){return this.splittable&&!this.single;},visualContainerStyle(){if(!this.isVisual){return{};}
let coord=[1,this.numVisualCols+1,1,this.numVisualRows+1];if(this.views.length>1){switch(this.visualOrientation){case'top':coord[2]=2;break;case'bottom':coord[3]=coord[3]-1;break;case'left':coord[0]=2;break;case'right':coord[1]=coord[1]-1;break;}}
return{position:'relative',top:null,left:null,right:null,bottom:null,gridColumnStart:coord[0],gridColumnEnd:coord[1],gridRowStart:coord[2],gridRowEnd:coord[3],zoom:1};},fullBaseURL(){let vm=this,base='',tmp;while(tmp=vm.baseURL){base=tmp+base;if(!vm.parents.length){break;}
vm=vm.parents[0];}
return base;},isDirty(){return!!this.dirtyContainers.length;},itsMaster(){if(this.master){return this;}
return bbn.fn.getRow(this.parents,{master:true})||this;},itsTabs(){if(!this.isBreadcrumb){return this.getRef('tabs');}
return false;},activeRealContainer(){if(bbn.fn.isNumber(this.selected)){return this.getRealVue(this.selected);}
return false;},activeRouter(){if(this.activeContainer){let sub=this.getSubRouter(this.selected);if(bbn.fn.isVue(sub)){return sub.activeRouter;}}
return this;},breadcrumbs(){let res=[];if(this.isBreadcrumb){res.push(this)}
if(this.breadcrumbsList.length){res.push(...this.getBreadcrumbs(this.selected))}
return res;},visualStyle(){if(!this.isVisual){return{};}
return{minHeight:'100%',display:'grid',gridColumnGap:'0.5em',gridRowGap:'0.5em',gridTemplateRows:'repeat('+this.numVisualRows+', 1fr)',gridTemplateColumns:'repeat('+this.numVisualCols+', 1fr)'}},visualIsOnHeight(){if(this.isVisual){return['top','bottom'].includes(this.visualOrientation);}
return false;},visualRatio(){if(!this.isVisual){return 1;}
let diffW=this.visualIsOnHeight?0:this.visualSize;let diffH=this.visualIsOnHeight?this.visualSize:0;let ratio=(this.lastKnownWidth-diffW)/(this.lastKnownHeight-diffH);if(ratio>2){return 2;}
return Math.max(0.5,ratio);},numVisualCols(){if(this.isVisual){let w=this.lastKnownWidth-(this.visualIsOnHeight?0:this.visualSize);if(this.visualRatio>=1){return Math.floor(w / this.visualSize);}
else{return Math.floor(w /(this.visualSize*this.visualRatio));}}
return 1;},numVisualRows(){if(this.isVisual){let h=this.lastKnownHeight-(this.visualIsOnHeight?this.visualSize:0);if(this.visualRatio>1){return Math.floor(h / this.visualSize*this.visualRatio);}
else{return Math.floor(h / this.visualSize);}}
return 1;},numVisuals(){if(this.isVisual){if(['left','right'].includes(this.visualOrientation)){return this.numVisualRows;}
else{return this.numVisualCols;}}
return 0;},numVisualReals(){if(this.isVisual){return bbn.fn.filter(this.visualList,a=>(a.view.idx!==this.selected)&&!a.view.pane).length;}
return 0;},visualList(){if(!this.isVisual){return[];}
let moreViewsThanSlots=this.numVisuals<this.views.length;let numAvailableSlots=this.numVisuals-(moreViewsThanSlots?1:0);let order=this.visualShowAll?{selected:'asc',static:'desc',pinned:'desc',last:'desc',idx:'asc'}:{selected:'desc',last:'desc',static:'desc',pinned:'desc',idx:'asc'};return bbn.fn.map(bbn.fn.multiorder(this.views,order),(a,i)=>{let visible=false;if(this.visualShowAll||(i<=numAvailableSlots)||(this.selected===a.index)){visible=true;}
return{view:a,visible:visible}});},tabsList(){return this.splittable?bbn.fn.filter(this.views,a=>!a.pane):this.views;},},methods:{isNumber:bbn.fn.isNumber,numProperties:bbn.fn.numProperties,remove(misc,force){let idx=this.getIndex(misc);if(idx>-1){let onBeforeClose=new Event('beforeClose',{cancelable:!force});let onClose=new Event('close');this.$emit('beforeClose',idx,onBeforeClose);if(force||!onBeforeClose.defaultPrevented){if(!force&&!this.ignoreDirty&&this.isDirty&&this.views[idx].dirty){this.confirm(this.confirmLeave,()=>{let forms=this.urls[this.views[idx].url].forms;if(Array.isArray(forms)&&forms.length){bbn.fn.each(forms,(f,k)=>{f.reset();});}
return this.close(idx,true);});}
else if(this.views[idx]&&!this.views[idx].real){this.$emit('close',idx,onClose);let url=this.views[idx].url;this.views.splice(idx,1);this.$delete(this.urls,url);this.fixIndexes();return true;}}}
return false;},getPane(obj){if(!obj){return false;}
if(this.isVisual){return obj.view.pane||false;}
return obj.pane||false;},selectClosest(idx){if((idx===this.selected)&&!this.views[idx].pane){return;}
if(this.selected===idx){if(this.views.length){let newIdx=false;bbn.fn.each(this.history,a=>{let tmp=this.getIndex(a);if((tmp!==false)&&!this.views[tmp].pane){newIdx=tmp;return false;}});if(newIdx===false){let tmp=idx;while(tmp>=0){if(this.views[tmp]&&!this.views[tmp].pane){newIdx=tmp;break;}
tmp--;}
if(newIdx===false){tmp=idx;while(tmp<this.views.length){if(this.views[tmp]&&!this.views[tmp].pane){newIdx=tmp;break;}
tmp++;}}}
if(this.views[newIdx]){this.activateIndex(newIdx);}}
else{this.selected=false;}}},close(idx,force,noCfg){let res=this.remove(idx,force);if(res){if(this.selected>idx){this.selected--;}
else if(idx===this.selected){this.selectClosest(idx);}
if(!noCfg){this.setConfig();}}
return res;},add(obj,idx){let index;if(bbn.fn.isObject(obj)&&bbn.fn.isString(obj.url)){obj.url=bbn.fn.replaceAll('//','/',obj.url);if(obj.$options){if(!obj.current&&!obj.currentURL){if(bbn.env.path.indexOf(this.getFullBaseURL()+(obj.url?obj.url+'/':''))===0){obj.currentURL=bbn.fn.substr(bbn.env.path,this.getFullBaseURL().length);}
else{obj.currentURL=obj.url;}}
else{if(obj.currentURL){obj.currentURL=bbn.fn.replaceAll(obj.currentURL);}}
let obj2=bbn.fn.extend(true,{},obj.$options.propsData),props=obj.$options.props;bbn.fn.iterate(props,(v,i)=>{if(!(i in obj2)&&('default'in v)){obj2[i]=v.default;}});bbn.fn.iterate(this.getDefaultView(),(a,n)=>{if(obj2[n]===undefined){obj2[n]=a;}});if(!obj2.current){if(bbn.env.path.indexOf(this.getFullBaseURL()+(obj2.url?obj2.url+'/':''))===0){obj2.current=bbn.fn.substr(bbn.env.path,this.getFullBaseURL().length);}
else{obj2.current=obj2.url;}}
else if((obj2.current!==obj2.url)&&(obj2.current.indexOf(obj2.url+'/')!==0)){obj2.current=obj2.url;}
if(!obj2.current){obj2.current=obj2.url;}
if(obj2.content){obj2.loaded=true;}
if(obj2.real&&!this.hasRealContainers){this.hasRealContainers=true;}
if(obj2.url===''){this.hasEmptyURL=true;}
if(this.search(obj2.url)===false){if(this.isValidIndex(idx)){this.views.splice(idx,0,obj2);}
else if(this.hasRealContainers&&(this.first!=='real')&&!obj2.real){idx=bbn.fn.search(this.views,{real:true});this.views.splice(idx,0,obj2);}
else{this.views.push(obj2);}}}
else{if(!obj.current){if(bbn.env.path.indexOf(this.getFullBaseURL()+(obj.url?obj.url+'/':''))===0){obj.current=bbn.fn.substr(bbn.env.path,this.getFullBaseURL().length);}
else{obj.current=obj.url;}}
else if((obj.current!==obj.url)&&(obj.current.indexOf(obj.url+'/')!==0)){obj.current=obj.url;}
if(!obj.current){obj.current=obj.url;}
if(obj.content){obj.loaded=true;}
obj.events={};if(obj.menu===undefined){obj.menu=[];}
index=this.search(obj.url);if(index!==false){let o=this.views[index],cn=this.urls[this.views[index].url];if(idx===undefined){idx=index;}
if(cn&&this.isValidIndex(idx)){cn.currentIndex=idx;}
if(obj.real){return;}
bbn.fn.iterate(obj,(a,n)=>{if(o[n]!==a){this.$set(o,n,a)}});}
else{let isValid=this.isValidIndex(idx);obj.selected=false;obj.idx=isValid?idx:this.views.length;bbn.fn.iterate(this.getDefaultView(),(a,n)=>{if(obj[n]===undefined){this.$set(obj,n,a);}});obj.uid=obj.url+'-'+bbn.fn.randomString();if(isValid){this.views.splice(obj.idx,0,obj);}
else if(this.hasRealContainers&&(this.first!=='real')&&!obj.real){idx=bbn.fn.search(this.views,{real:true});this.views.splice(idx,0,obj);}
else{this.views.push(obj);}}}
this.fixIndexes()}},init(url){if(!this.isInit){if(this.numRegistered){this.isInit=true;}
setTimeout(()=>{if(this.auto){this.route(url,true);}},50)}},register(cp,fake){if(fake){this.add(cp);return;}
if(!bbn.fn.isString(cp.url)){throw Error(bbn._('The component bbn-container must have a URL defined'));}
if(this.urls[cp.url]){throw Error(bbn._('Two containers cannot have the same URL defined ('+cp.url+')'));}
this.numRegistered++;this.urls[cp.url]=cp;if(this.isVisual){cp.$on('view',()=>{this.visualShowAll=false;})}
let idx=this.search(cp.url);if(idx===false){this.add(cp);}
else{cp.currentIndex=idx;}
if(this.numRegistered===this.views.length){this.init(this.getDefaultURL());}
this.$emit('registered',cp.url)},unregister(cp){if(!bbn.fn.isString(cp.url)){throw Error(bbn._('The component bbn-container must have a URL defined'));}
this.numRegistered--;let idx=this.search(cp.url),dataObj=this.postBaseUrl?{_bbn_baseURL:this.fullBaseURL}:{},requestID=bbn.fn.getRequestId(cp.url,dataObj);if(bbn.fn.getLoader(requestID)){bbn.fn.abort(requestID);}
if(this.urls[cp.url]!==undefined){delete this.urls[cp.url];}
if(idx!==false){}},getRoute(url,force){if(!bbn.fn.isString(url)){throw Error(bbn._('The bbn-container must have a valid URL defined'));}
if(!url&&this.hasEmptyURL){return'';}
if(!url&&!this.parent){url=this.parseURL(bbn.env.path);}
if(!url&&force&&this.parent){url=this.parseURL(this.router.getFullCurrentURL());}
if(url){let bits=url.split('/');while(bits.length){let st=bits.join('/');if(this.urls[st]){return this.urls[st].disabled?'':st;}
bits.pop();}}
if(this.def&&force){return this.def}
if(this.views.length&&force){return this.views[0].current}
return false;},formatBaseURL(baseURL){while(bbn.fn.substr(baseURL,-1)==='/'){baseURL=bbn.fn.substr(baseURL,0,baseURL.length-1);}
while(bbn.fn.substr(baseURL,0,1)==='/'){baseURL=bbn.fn.substr(baseURL,1);}
return baseURL?baseURL+'/':'';},getDefaultView(){return{source:null,title:bbn._("Untitled"),options:null,cached:!this.single&&this.nav,scrollable:true,component:null,icon:'',notext:false,content:null,menu:[],loaded:null,fcolor:null,bcolor:null,load:false,pane:false,selected:null,css:'',advert:null,dirty:false,help:null,imessages:[],script:null,static:false,pinned:false,url:null,current:null,real:false,cfg:{},events:{},real:false,last:0};},route(url,force){if(!bbn.fn.isString(url)){throw Error(bbn._('The component bbn-container must have a valid URL defined'));}
url=bbn.fn.replaceAll('//','/',url);let ok=true;if(this.splittable){bbn.fn.each(this.currentPanes,a=>{bbn.fn.each(a.tabs,(v,i)=>{if(url.indexOf(v.url)===0){let container=this.urls[v.url];if(!container){ok=false;}
if(a.selected!==i){a.selected=i;ok=false;return false;}}})
if(!ok){return false;}});}
if(ok&&this.ready&&(force||!this.activeContainer||(url!==this.currentURL))){let event=new CustomEvent("beforeroute",{bubbles:false,cancelable:true});this.$emit("beforeroute",event,url);if(!event.defaultPrevented){let bits=url.split('#');url=bits[0];if((url==='')&&this.hasEmptyURL){this.urls[''].setCurrent(url);this.realRoute('','',force);return;}
if(!url){let idx=this.getRoute('',true);if(idx&&this.urls[idx]){url=this.urls[idx].currentURL;}}
let st=url?this.getRoute(url):'';if(!url||(!force&&(this.currentURL===url))){if(bits[1]){}
return;}
else if(url&&((!st&&this.autoload)||(this.urls[st]&&this.urls[st].load&&!this.urls[st].isLoaded))){this.load(url);}
else{if(!st&&this.def&&(!url||force)){st=this.getRoute(this.def);if(st){url=this.def;}}
if(!st&&force&&this.views.length){st=this.views[0].url;if(st){url=this.urls[st]?this.urls[st].currentURL:st;}}
if(st){if(this.urls[st]){this.urls[st].setCurrent(url);}
this.realRoute(url,st,force,bits[1]);}}}}},realRoute(url,st,force,anchor){if(!bbn.fn.isString(url)&&!bbn.fn.isNumber(url)){throw Error(bbn._('The component bbn-container must have a valid URL defined'));}
if(this.urls[st]){if(!this.urls[st].isPane&&(url!==this.currentURL)){this.currentURL=url;}
if(!this.urls[st].currentView.pane){if(!this.routed){this.routed=true;this.$emit("route1",this);}}
this.activate(url,this.urls[st]);if(this.urls[st]&&this.urls[st].isLoaded){this.urls[st].currentURL=url;this.$nextTick(()=>{let child=this.urls[st].find('bbn-router');if(child){child.route(bbn.fn.substr(url,st.length+1),force);}
else{let ifr=this.urls[st].find('bbn-frame');if(ifr){ifr.route(bbn.fn.substr(url,st.length+1));}}});}}},next(force){let next=this.selected+1;if(!this.views[next]&&force){next=0;}
if(this.views[next]){this.activateIndex(next);}},prev(force){let prev=this.selected-1;if(!this.views[prev]&&force){prev=this.views.length-1;}
if(this.views[prev]){this.activateIndex(prev);}},activate(url,container){if(!bbn.fn.isString(url)){throw Error(bbn._('The component bbn-container must have a valid URL defined'));}
if(!container){let row=bbn.fn.getRow(this.views,{current:url});if(!row){row=bbn.fn.getRow(this.views,{url:url});}
if(!row){throw new Error(bbn._("Impossible to find a container for the URL %s",url));}
if(!this.urls[row.url]){throw new Error(bbn._("The container for the URL %s is not registered",row.url));}
container=this.urls[row.url];}
if(this.selected!==container.currentIndex){container.setCurrent(url);if(!container.isPane){this.activeContainer=container;}
container.show();if(this.scrollable&&this.nav&&!this.breadcrumb){let scroll=this.getRef('horizontal-scroll');let tab=this.getRef('tab-'+container.currentIndex);if(scroll.ready){scroll.scrollTo(tab);}
else if(scroll){scroll.$on('ready',sc=>{setTimeout(()=>{sc.scrollTo(this.getRef('tab-'+container.currentIndex));},100);})}}}
else if(url!==container.currentURL){if(container.routers){let rt;bbn.fn.iterate(container.routers,(r,n)=>{if(!rt){rt=r;}
if(url.indexOf(r.baseURL)===0){rt=r;return false;}});if(rt){rt.route(url.indexOf(rt.baseURL)===0?bbn.fn.substr(url,rt.baseURL.length):'');}}
else{this.activeContainer.setCurrent(url);}}},changeURL(url,title,replace){if(!bbn.fn.isString(url)){throw Error(bbn._('The component bbn-container must have a valid URL defined'));}
if(!bbn.env.isInit){return;}
if(title&&(title!==this.currentTitle)){this.currentTitle=title;}
if(url!==this.currentURL){this.currentURL=url;return;}
if(this.views[this.selected]&&((url.indexOf(this.views[this.selected].url+'/')===0)||(url===this.views[this.selected].url))){this.$set(this.views[this.selected],'current',url);}
if(this.urlNavigation){if(this.parentContainer){this.parentContainer.currentTitle=title+' < '+this.parentContainer.title;if(!this.parentContainer.isPane){this.parent.changeURL(this.baseURL+url,this.parentContainer.currentTitle,replace);}}
else if(replace||(url!==bbn.env.path)){if(!replace){}
if(!replace&&((this.getFullBaseURL()+url).indexOf(bbn.env.path)===0)){replace=true;}
bbn.fn.setNavigationVars(this.getFullBaseURL()+url,this.currentTitle,{},replace);}}},getBaseURL(){return this.baseURL;},getFullBaseURL(){return this.fullBaseURL;},getFullURL(){let url=this.getURL();if(url!==false){return this.getFullBaseURL()+url;}
return'';},getCurrentURL(){return this.currentURL;},getFullCurrentURL(){let url=this.getCurrentURL();if(url!==false){return this.getFullBaseURL()+url;}
return false;},parseURL(fullURL){let url=fullURL;if(fullURL===undefined){return'';}
if(!bbn.fn.isString(fullURL)){fullURL=fullURL.toString();}
if(fullURL.indexOf(bbn.env.root)===0){fullURL=bbn.fn.substr(fullURL,bbn.env.root.length);}
fullURL=bbn.fn.removeTrailingChars(fullURL,'/');if(this.fullBaseURL===(fullURL+'/')){return'';}
if(this.fullBaseURL){if(fullURL.indexOf(this.fullBaseURL)===0){fullURL=bbn.fn.substr(fullURL,this.fullBaseURL.length);}
else{fullURL='';}}
return fullURL;},isValidIndex(idx){return(typeof idx==='number')&&(this.views[idx]!==undefined);},activateDefault(){let idx=this.getIndex('',true);if(this.isValidIndex(idx)){this.activate(this.views[idx].current?this.views[idx].current:this.views[idx].url);}},activateIndex(idx){if(this.isValidIndex(idx)){this.route(this.urls[this.views[idx].url]?this.urls[this.views[idx].url].currentURL:this.views[idx].current);}},getVue(idx){if(idx===undefined){idx=this.selected;}
if(this.isValidIndex(idx)){return this.urls[this.views[idx].url];}
return false;},getContainer(idx){if(idx===undefined){idx=this.selected;}
return this.urls[this.views[idx].url];},getDOMContainer(idx){if(idx===undefined){idx=this.selected;}
let c=this.getVue(idx);return c?c.$el:false;},getSubRouter(misc){let idx=this.getIndex(misc);if(idx===undefined){idx=this.selected;}
let container=this.getVue(idx);if(container){return container.find('bbn-router')||null;}
return null;},getRealVue(misc){let idx=this.getIndex(misc),router=this,sub=router;if(idx===undefined){idx=this.selected;}
while(router){router=sub.getSubRouter(idx);if(router){sub=router;idx=sub.selected;}}
return sub.getVue(idx);},getIndex(misc){if(!this.views.length){return false;}
if([undefined,null].includes(misc)){return this.selected;}
if(!this.isValidIndex(misc)){if(typeof(misc)==='string'){misc=this.search(misc);}
else if(typeof(misc)==='object'){if(misc.$el){misc=misc.$el;}
if(misc.tagName){bbn.fn.each(this.$children,ct=>{if(ct.$vnode&&ct.$vnode.componentOptions&&(ct.$vnode.componentOptions.tag==='bbn-container')&&((ct.$el===misc)||ct.$el.contains(misc))){misc=ct.currentIndex;return false;}});}}}
return this.isValidIndex(misc)?misc:false;},fixIndexes(){bbn.fn.each(this.views,(v,i)=>{if(v.idx!==i){v.idx=i;if(this.urls[v.url]){this.urls[v.url].currentIndex=i;}}});},move(from,to){if(!bbn.fn.isNumber(from,to)||(from===to)||!this.views[from]||!this.views[to]){return;}
bbn.fn.move(this.views,from,to);let selectedOk=false;if(from===this.selected){this.selected=to;selectedOk=true;}
for(let i=Math.min(from,to);i<=Math.max(from,to);i++){if(this.views[i].idx!==i){if(!selectedOk&&(this.selected===this.views[i].idx)){this.selected=i;}
this.views[i].idx=i;}}
this.setConfig();},search(url){if(!bbn.fn.isString(url)){throw Error(bbn._('The component bbn-container must have a valid URL defined'));}
let r=bbn.fn.search(this.views,"url",url);if(r===-1){bbn.fn.each(this.views,(tab,index)=>{if(url.indexOf(tab.url+'/')===0){r=index;return false;}});}
return r>-1?r:false;},searchForString(needle){let res=[];let st=needle.toLowerCase().trim();bbn.fn.each(this.views,a=>{let found=false;bbn.fn.iterate(this.routers,router=>{let tmp=router.searchForString(needle);if(tmp.length){bbn.fn.each(tmp,t=>{t.url=this.getBaseURL()+t.url;if(!bbn.fn.getRow(res,{url:t.url})){found=true;res.push(t);}});}});if(!found){let match=false;let idx=-1;let obj={url:a.current||a.url,title:this.getFullTitle(a)};if((idx=obj.url.toLowerCase().indexOf(st))>-1){match="url";}
else if((idx=obj.title.toLowerCase().indexOf(st))>-1){match="title";}
if(match){let url=this.getBaseURL()+obj.url;res.push({url:url,title:obj.title,score:match==='url'?10:20,icon:a.icon||null,hash:url,bcolor:a.bcolor||null,fcolor:a.fcolor||null,component:this.$options.components.searchResult,match:bbn.fn.substr(obj[match],0,idx)
+'<strong><em>'
+bbn.fn.substr(obj[match],idx,st.length)
+'</em></strong>'
+bbn.fn.substr(obj[match],idx+st.length)});}}});return res;},callRouter(url,st){if(!bbn.fn.isString(url)){throw Error(bbn._('The component bbn-container must have a valid URL defined'));}
if(this.parent){let containers=this.ancestors('bbn-container');url=bbn.fn.substr(this.getFullBaseURL(),this.router.baseURL.length)+url;this.router.realRoute(url,containers[containers.length-1].url,true);}
else{this.realRoute(url,st,true);}},searchContainer(url,deep){let container=false,idx=this.search(url);if(idx!==false){container=this.getContainer(idx);if(deep&&container){let router=container.find('bbn-router');if(router){let real=router.searchContainer(bbn.fn.substr(url,router.baseURL.length),true);if(real){return real;}}}}
return container;},load(url,force,index){if(url){this.isLoading=true;let finalURL=this.fullBaseURL+url;let idx=this.search(url);let toAdd=false;let view;if(idx!==false){if(this.views[idx].loading||(!force&&!this.views[idx].load)){return;}
view=this.views[idx];if(force){let kept={loading:true,loaded:false,load:true,url:view.url,current:url,selected:true,cached:view.cached!==undefined?view.cached:(this.single||!this.nav?false:true),pane:view.pane,title:view.title,static:view.static,pinned:view.pinned,index:idx};if(view.icon){kept.icon=view.icon;}
if(view.bcolor){kept.bcolor=view.bcolor;}
if(view.fcolor){kept.fcolor=view.fcolor;}
bbn.fn.iterate(bbn.fn.extend(this.getDefaultView(),kept),(a,n)=>{if(view[n]!==a){this.$set(view,n,a);}});if(this.urls[url]){this.urls[url].isLoaded=false;this.urls[url].dirty=false;}}
if((index!==undefined)&&(idx!==index)){this.move(idx,index);idx=index;}}
else{toAdd=true;idx=index===undefined?this.views.length:index;}
if(toAdd){this.add({url:url,title:view&&view.title?view.title:bbn._('Loading'),load:true,loading:true,real:false,pane:false,scrollable:!this.single,current:url,error:false,loaded:false,hidden:false},idx);}
else if(!this.views[idx].loading){this.views[idx].loading=true;}
if(!this.views[idx].pane){this.selected=idx;}
this.$forceUpdate();this.$emit('update',this.views);let dataObj=this.postBaseUrl?{_bbn_baseURL:this.fullBaseURL}:{};return this.post(finalURL,dataObj,d=>{let callRealInit=true;this.isLoading=false;if(d.url){d.url=this.parseURL(d.url);}
if(!d.url){d.url=url;}
if(url.indexOf(d.url)===0){d.current=url;}
if(d.data&&bbn.fn.numProperties(d.data)){d.source=d.data;delete d.data;}
if((d.url!==d.current)&&this.urls[d.current]){bbn.fn.warning("DELETING VIEW CASE.... "+d.current+' '+this.urls[d.current].currentIndex,d.url,bbn.fn.search(this.views,{idx:this.urls[d.current].idx}));this.remove(this.urls[d.current].currentIndex,true);callRealInit=false;}
if(!d.title||(d.title===bbn._('Loading'))){if(view&&view.title){d.title=view.title;}
else{let title=bbn._('Untitled');let num=0;while(bbn.fn.search(this.views,{title:title})>-1){num++;title=bbn._('Untitled')+' '+num;}
d.title=title;}}
if(!d.current&&d.url){d.current=d.url;}
this.$nextTick(()=>{let o=bbn.fn.extend(view||{},d,{loading:false,load:true,real:false,loaded:true});this.add(o,idx);if(o.title){this.currentTitle=o.title;}
this.$nextTick(()=>{if(callRealInit){this.realInit(d.url);}})})},xhr=>{this.isLoading=false;let idx=this.search(this.parseURL(finalURL));if(idx!==false){let url=this.views[idx].url;if(this.urls[url]){this.urls[url].errorStatus=xhr;this.urls[url].setTitle(bbn._("Error"));this.urls[url].setIcon("nf nf-fa-warning");this.callRouter(finalURL,url);}}},()=>{this.isLoading=false;let idx=this.search(this.parseURL(finalURL));if(idx!==false){let url=this.views[idx].url;if(this.urls[url]){this.callRouter(finalURL,url);this.$nextTick(()=>{this.close(idx);});}}});}},realInit(url){if(this.urls[url]){this.urls[url].setLoaded(true);this.urls[url].init();this.callRouter(this.urls[url].current,url);this.$emit('update',this.views);}
else{}},checkLoaded(idx){return this.views[idx]&&this.views[idx].load&&this.urls[this.views[idx].url]&&this.urls[this.views[idx].url].isLoaded;},reload(idx,force){if(this.checkLoaded(idx)){let url=this.views[idx].current;if(!force&&!this.ignoreDirty&&this.isDirty&&this.views[idx].dirty){this.confirm(this.confirmLeave,()=>{if(this.checkLoaded(idx)){let forms=this.urls[this.views[idx].url].forms;if(Array.isArray(forms)&&forms.length){bbn.fn.each(forms,(f,k)=>{f.reset();});}
this.load(url,true,idx);}});}
else{this.$nextTick(()=>{this.load(url,true,idx);});}}},getDefaultURL(){let url='';if(this.autoload){url=this.parseURL(bbn.env.path);}
if(!url&&this.url){url=this.url;}
if(!url&&this.parentContainer&&(this.parentContainer.currentURL!==this.parentContainer.url)){url=bbn.fn.substr(this.parentContainer.currentURL,this.parentContainer.url.length+1);}
if(!url&&this.def){url=this.def;}
if(!this.autoload&&!url){url=this.parseURL(bbn.env.path);}
return url;},getTitle(idx){let cp=this,res='';if(idx===undefined){idx=this.selected;}
if(cp.views[idx]){res+=(cp.views[idx].title||bbn._('Untitled'));if(cp.parentTab){idx=cp.parentTab.currentIndex;cp=cp.parentTab.router;while(cp){res+=' < '+(cp.views[idx].title||bbn._('Untitled'));if(cp.parentTab){idx=cp.parentTab.currentIndex;cp=cp.parentTab.router;}
else{cp=false;}}}
res+=' - ';}
res+=bbn.env.siteTitle||bbn._("Untitled site")
return res;},retrieveDirtyContainers(){this.dirtyContainers.splice(0,this.dirtyContainers.length);bbn.fn.iterate(this.urls,v=>{if(v.dirty){this.dirtyContainers.push({idx:v.currentIndex,url:v.url});}});},onEscape(e){if(this.isVisual&&this.visualShowAll){this.visualShowAll=false;e.stopPropagation();e.preventDefault();}},getMenuFn(idx){if(!this.nav||!this.views[idx]||(this.views[idx].menu===false)){return[];}
let items=[];let tmp=((bbn.fn.isFunction(this.views[idx].menu)?this.views[idx].menu():this.views[idx].menu)||[]).slice();let others=false;let container=this.getVue(idx);bbn.fn.each(this.views,(a,i)=>{if((i!==idx)&&!a.static){others=true;return false;}});if(!this.views[idx].help){let sub=this.getSubRouter(idx);if(sub&&sub.views&&sub.views.length){let helps=[];sub.views.forEach(a=>{if(a.help){helps.push({url:sub.fullBaseURL+a.url,content:a.help,title:a.title||a.url,anchor:bbn.fn.randomString(15,20).toLowerCase()});}});if(helps.length===1){this.views[idx].help=helps[0].content;}
else if(helps.length){this.views[idx].help='';let slide1='';helps.forEach(a=>{slide1+='<h1><a href="#'+a.anchor+'">'+a.title+'</a></h1>\n';this.views[idx].help+='---slide---'+'\n<a name="'+a.anchor+'">\n'+a.content;});this.views[idx].help=slide1+this.views[idx].help;}}}
if(this.views[idx].help){items.push({text:bbn._("Help"),key:"help",icon:"nf nf-mdi-help_circle_outline",action:()=>{let view=this.getVue(idx),span=document.createElement('span');span.innerHTML=this.views[idx].title;let title=span.innerText;if(!title&&span.querySelector("[title]").length){title=span.querySelector("[title]").getAttribute("title");}
view.getPopup({scrollable:false,component:{props:['source'],template:`
                  <bbn-slideshow :source="source.content"
                                class="bbn-bg-webblue bbn-white"
                                :full-slide="true"
                                separator="---slide---"></bbn-slideshow>`},source:{content:this.views[idx].help},title:'<i class="bbn-large nf nf-mdi-help_circle_outline"> </i> <span class="bbn-iblock">'+title+'</span>',width:'90%',height:'90%'});}})}
if(this.autoload||this.views[idx].load){items.push({text:bbn._("Reload"),key:"reload",icon:"nf nf-mdi-sync",action:()=>{this.reload(idx);}});}
if(container&&container.fullScreen){items.push({text:bbn._("Exit full screen"),key:"reduce",icon:"nf nf-mdi-arrow_collapse",action:()=>{container.fullScreen=false;}});}
else if(container&&!container.isPane){items.push({text:bbn._("Enlarge"),key:"enlarge",icon:"nf nf-mdi-arrow_expand_all",action:()=>{container.fullScreen=true;}});}
if(tmp&&tmp.length){bbn.fn.each(tmp,(a,i)=>{items.push(a)});}
if(this.views[idx].icon&&this.views[idx].title&&!this.isBreadcrumb&&!this.isVisual){items.push({text:this.views[idx].notext?bbn._("Show text"):bbn._("Show only icon"),key:"notext",icon:this.views[idx].notext?"nf nf-fa-font":"nf nf-fa-font_awesome",action:()=>{this.$set(this.views[idx],'notext',!this.views[idx].notext);}});}
if(window.appui){items.push({text:bbn._("Create a shortcut"),key:"shortcut",icon:"nf nf-fa-link",action:()=>{this.$emit('shortcut',{text:this.views[idx].title,icon:this.views[idx].icon||'nf nf-fa-link',url:this.getFullBaseURL()+this.views[idx].url});}});}
if(container){items.push({text:bbn._("Copy content text"),icon:"nf nf-fa-copy",key:"text_copy",action:()=>{let scroll=container.getRef('scroll');let ok=false;if(scroll){let scrollContent=scroll.getRef('scrollContent');if(scrollContent){bbn.fn.copy(scrollContent.innerText)
ok=true;}}
if(ok){appui.success(bbn._("Copied!"))}
else{appui.error(bbn._("Not copied!"))}}});items.push({text:bbn._("Copy content HTML"),icon:"nf nf-fa-html5",key:"html_copy",action:()=>{let scroll=container.getRef('scroll');let ok=false;if(scroll){let scrollContent=scroll.getRef('scrollContent');if(scrollContent){bbn.fn.copy(scrollContent.innerHTML)
ok=true;}}
if(ok){appui.success(bbn._("Copied!"))}
else{appui.error(bbn._("Not copied!"))}}});items.push({text:bbn._("Screenshot"),icon:"nf nf-mdi-image_album",key:"screenshot",items:[{text:bbn._("Download"),key:"screenshot_dl",icon:"nf nf-mdi-arrow_expand_all",action:()=>{container.takeScreenshot().then(canvas=>{if(canvas){bbn.fn.downloadContent(bbn.fn.replaceAll('/','-',container.getFullCurrentURL()+'_'+bbn.fn.dateSQL(undefined,true)+'.png'),canvas)}});}},{text:bbn._("Copy"),key:"screenshot_copy",icon:"nf nf-mdi-image_multiple",action:()=>{container.takeScreenshot(0.5).then(canvas=>{if(canvas){canvas.toBlob(blob=>{bbn.fn.copy(blob).then(()=>{appui.success();})});}});}},{text:bbn._("Copy full size"),key:"screenshot_copy",icon:"nf nf-mdi-image_multiple",action:()=>{container.takeScreenshot(1).then(canvas=>{if(canvas){canvas.toBlob(blob=>{bbn.fn.copy(blob).then(()=>{appui.success();})});}});}}]});}
if(!this.views[idx].static&&!this.views[idx].pane){if(this.isBreadcrumb){items.push({text:bbn._("Close"),key:"close",icon:"nf nf-mdi-close",action:()=>{this.close(idx);}});}
else{if(!this.views[idx].pinned){items.push({text:bbn._("Pin"),key:"pin",icon:"nf nf-mdi-pin",action:()=>{this.pin(idx);}});items.push({text:bbn._("Close"),key:"close",icon:"nf nf-mdi-close",action:()=>{this.close(idx);}})}
else{items.push({text:bbn._("Unpin"),key:"pin",icon:"nf nf-mdi-pin_off",action:()=>{this.unpin(idx);}});}}}
if(others&&!this.views[idx].pane){items.push({text:bbn._("Close Others"),key:"close_others",icon:"nf nf-mdi-close_circle_outline",action:()=>{this.closeAllBut(idx);}});if(!this.isVisual){let directions=[];if(idx){if(idx>1){directions.push({text:bbn._("First"),key:"move_first",icon:"nf nf-mdi-close_circle_outline",action:()=>{this.move(idx,0);}});}
directions.push({text:bbn._("Before"),key:"move_before",icon:"nf nf-mdi-close_circle_outline",action:()=>{this.move(idx,idx-1);}});}
if(idx<(this.views.length-1)){directions.push({text:bbn._("After"),key:"move_after",icon:"nf nf-mdi-close_circle_outline",action:()=>{this.move(idx,idx+1);}});if(idx<(this.views.length-2)){directions.push({text:bbn._("Last"),key:"move_last",icon:"nf nf-mdi-close_circle_outline",action:()=>{this.move(idx,this.views.length-1);}});}}
if(directions.length){if(directions.length===1){directions[0].text=bbn._("Switch position");items.push(directions[0]);}
else{items.push({text:bbn._("Move"),key:"move",icon:"nf nf-mdi-close_circle_outline",items:directions});}}}}
if(container&&this.splittable){if(container.isPane){items.push({text:bbn._("Remove from pane"),key:"unpane",icon:"nf nf-mdi-window_restore",action:()=>{this.removeFromPane(idx);}});}
else{items.push({text:bbn._("Show in a new pane"),key:"split",icon:"nf nf-mdi-format_horizontal_align_right",action:()=>{this.addToPane(idx);}});if(this.currentPanes.length){let tmp={text:bbn._("Show in pane"),key:"panes",icon:"nf nf-mdi-checkbox_multiple_blank_outline",items:[]};bbn.fn.each(this.currentPanes,(a,i)=>{tmp.items.push({text:'Pane <div class="bbn-badge">'+(i+1)+'</div>',key:"pane"+(i+1),action:()=>{this.addToPane(idx,a.id);}})});items.push(tmp);}}}
if(others&&!this.views[idx].static&&!this.views[idx].pane){items.push({text:bbn._("Close All"),key:"close_all",icon:"nf nf-mdi-close_circle",action:()=>{this.closeAll();}});}
if(!this.views[idx].pane&&!this.parent){items.push({text:bbn._("Configuration"),key:"config",icon:"nf nf-fa-cogs",action:()=>{this.showRouterCfg=true;}});}
let menu=bbn.fn.isArray(this.menu)?this.menu:this.menu(this.views[idx],this);if(menu.length){bbn.fn.each(menu,a=>{items.push(a);});}
return items;},setConfig(){if(this.autoload&&this.isInit){this.setStorage(this.getConfig(),this.parentContainer?this.parentContainer.getFullURL():this.storageName);}},getConfig(){let cfg={baseURL:this.parentContainer?this.parentContainer.getFullURL():this.storageName,views:[],breadcrumb:this.isBreadcrumb,visual:this.isVisual,orientation:this.lockedOrientation?this.visualOrientation:null,panes:this.currentPanes.map(a=>{return{id:a.id,tabs:[],selected:a.selected}})};bbn.fn.each(this.views,(obj,i)=>{if(obj.url&&obj.load){let res={url:obj.url,icon:obj.icon||false,notext:obj.notext||false,load:true,loaded:false,title:obj.title?obj.title:bbn._('Untitled'),static:!!obj.static,pinned:!!obj.pinned,pane:obj.pane||false,current:obj.current?obj.current:obj.url,cfg:{},real:obj.real,last:obj.last};if(obj.bcolor){res.bcolor=obj.bcolor;}
if(obj.fcolor){res.fcolor=obj.fcolor;}
cfg.views.push(res);}});return cfg;},unsetConfig(){if(this.autoload){this.unsetStorage(this.parentContainer?this.parentContainer.getFullURL():this.storageName);}},observerEmit(newVal,obs){if(bbn.vue.observerComponent.methods.observerEmit.apply(this,[newVal,obs])){let ele=this.$el.querySelector(".bbn-observer-"+obs.element);if(ele){let idx=this.getIndex(ele);if(idx!==false){this.$set(this.views[idx].events,'bbnObs'+obs.element+obs.id,newVal);this.$nextTick(()=>{});}}}},observerClear(obs){let ele=this.$el.querySelector(".bbn-observer-"+obs.element);if(ele){let idx=this.getIndex(ele);if((idx!==false)&&(this.views[idx].events['bbnObs'+obs.element+obs.id]!==undefined)){this.$delete(this.views[idx].events,'bbnObs'+obs.element+obs.id);this.$nextTick(()=>{});}}
else if(this.observationTower){this.observationTower.observerClear(obs);}},enter(container){},cutTitle(title){return bbn.fn.shorten(title,this.maxTitleLength)},getFullTitle(obj){let t='';if(obj.title){t+=obj.title;}
if(obj.ftitle){t+=(t.length?' - ':'')+obj.ftitle;}
return t;},getFontColor(idx){if(bbn.fn.isNumber(idx)){if(this.views[idx]&&this.views[idx].fcolor){return this.views[idx].fcolor;}
let el=this.getRef('title-'+idx);if(el){return window.getComputedStyle(el.$el?el.$el:el).color;}}
return'';},getBackgroundColor(idx){if(bbn.fn.isNumber(idx)){if(this.views[idx]&&this.views[idx].bcolor){return this.views[idx].bcolor;}
let el=this.getRef('title-'+idx);if(el){return window.getComputedStyle(el.$el?el.$el:el).backgroundColor;}}
return'';},getTab(idx){if(idx===undefined){idx=this.selected;}
return this.getRef('tabs').getRef('tab-'+idx);},closeAll(force){for(let i=this.views.length-1;i>=0;i--){if(!this.views[i].static&&!this.views[i].pinned){this.close(i,force,true);}}
this.setConfig();},closeAllBut(idx,force){for(let i=this.views.length-1;i>=0;i--){if(!this.views[i].static&&!this.views[i].pinned&&(i!==idx)){this.close(i,force,true);}}
this.setConfig();},pin(idx){if(this.isValidIndex(idx)){let ev=new CustomEvent('beforePin',{cancelable:true});this.$emit('beforePin',idx,ev);if(!ev.defaultPrevented){this.views[idx].pinned=true;this.setConfig();this.$emit('pin',idx);}}},unpin(idx){if(this.isValidIndex(idx)){let ev=new CustomEvent('beforeUnpin',{cancelable:true});this.$emit('beforeUnpin',idx,ev);if(!ev.defaultPrevented){this.views[idx].pinned=false;this.setConfig();this.$emit('unpin',idx);}}},registerRouter(router){this.routers[bbn.fn.substr(router.getBaseURL(),0,-1)]=router;},unregisterRouter(router){delete this.routers[bbn.fn.substr(router.getBaseURL(),0,-1)];},registerBreadcrumb(bc){let url=bbn.fn.substr(bc.baseURL,0,bc.baseURL.length-1);this.breadcrumbsList.push(bc);if(this.itsMaster&&!this.master){this.itsMaster.breadcrumbsList.push(bc);}},unregisterBreadcrumb(bc){let url=bbn.fn.substr(bc.baseURL,0,bc.baseURL.length-1);let idx=bbn.fn.search(this.breadcrumbsList,{baseURL:bc.baseURL});if(idx!==-1){this.breadcrumbsList.splice(idx,1);}
if(this.itsMaster&&!this.master){idx=bbn.fn.search(this.itsMaster.breadcrumbsList,{baseURL:bc.baseURL});if(idx!==-1){this.itsMaster.breadcrumbsList.splice(idx,1);}}},getBreadcrumbs(idx){let ret=[];if(bbn.fn.isNumber(idx)&&this.views[idx]){let url=this.views[idx].url,bc=bbn.fn.getRow(this.breadcrumbsList,{baseURL:url+'/'});if(this.urls[url]&&bc){ret.push(...bc.breadcrumbs);}}
return ret;},getList(idx){let list=[],parents=bbn.fn.map(idx&&this.itsMaster&&(this.baseURL!==this.itsMaster.baseURL)?this.getParents():[],p=>{return{view:p.views[p.selected],maxTitleLength:p.maxTitleLength}});if(parents.length>idx){parents.splice(0,parents.length-idx);}
bbn.fn.each(this.views,(t,i)=>{if(!t.hidden&&(t.idx!==this.selected)&&!t.pane){list.push({view:t,key:t.url,parents:parents,children:bbn.fn.map(this.getBreadcrumbs(i),c=>{return{view:c.views[c.selected],maxTitleLength:c.maxTitleLength}}),maxTitleLength:this.maxTitleLength,action:()=>{this.activateIndex(t.idx);},closeAction:()=>{return this.close(t.idx)}})}});return list;},getParents(){return this.parent?[...this.parent.getParents(),this.parent]:[]},onResize(){this.keepCool(()=>{if(this.setResizeMeasures()&&this.setContainerMeasures()){this.$emit('resize');}
if(this.isVisual&&(this.orientation==='auto')&&!this.lockedOrientation){this.visualOrientation=this.lastKnownWidth>this.lastKnownHeight?'left':'top';}},'resize',50);},getView(url){return bbn.fn.getRow(this.views,{url:url})},visualStyleContainer(ct){if(!ct.isVisible||this.visualShowAll){return{zoom:0.1};}
let num=this.numVisuals+1;let coord=[1,num,1,num];switch(this.visualOrientation){case'up':coord[2]=2;break;case'down':coord[3]=num-1;break;case'left':coord[0]=2;break;case'right':coord[1]=num-1;break;}
return{gridColumnStart:coord[0],gridColumnEnd:coord[1],gridRowStart:coord[2],gridRowEnd:coord[3],zoom:1}},addPane(paneId,selected){if(this.splittable){if(!paneId){paneId=bbn.fn.randomString().toLowerCase();}
if(!bbn.fn.getRow(this.currentPanes,{id:paneId})){this.currentPanes.push({id:paneId,tabs:[],selected:selected===undefined?-1:selected});}}
return paneId;},closeTab(idx){this.close(this.tabsList[idx].idx);},removePane(paneId){if(this.splittable){let paneIndex=bbn.fn.search(this.currentPanes,{id:paneId});let pane=this.currentPanes[paneIndex];if(!pane){throw new Error(bbn._("Impossible to find the pane with ID %s",paneId));}
if(pane.tabs.length){throw new Error(bbn._("Impossible to remove the pane with ID %s as it has still containers inside",paneId));}
this.currentPanes.splice(paneIndex,1);if(this.routed){this.$nextTick(()=>this.getRef('splitter').init());}}},addToPane(containerIdx,paneId){let view=this.views[containerIdx];if(!view){throw new Error(bbn._("Impossible to find the view with index")+' '+containerIdx);}
if(view.dirty){this.alert(bbn._("Save your changes or discard them before moving the container"));return;}
let pane=bbn.fn.getRow(this.currentPanes,{id:paneId});if(!pane){paneId=this.addPane(paneId);pane=bbn.fn.getRow(this.currentPanes,{id:paneId});}
this.$set(this.views[containerIdx],"pane",paneId);pane.tabs.push(view);setTimeout(()=>{if(containerIdx===this.selected){this.selectClosest(containerIdx);}
pane.selected=pane.tabs.length-1;},250);},removeFromPane(containerIdx){let view=this.views[containerIdx];if(view){if(view.dirty){this.alert(bbn._("Save your changes or discard them before moving the container"));return;}
let paneId=view.pane;if(paneId){let pane=bbn.fn.getRow(this.currentPanes,{id:paneId});let idx=bbn.fn.search(pane.tabs,{idx:containerIdx});if(idx>-1){this.selected=containerIdx;view.pane=false;this.$nextTick(()=>{pane.tabs.splice(idx,1);if(!pane.tabs.length){this.removePane(paneId);}
else if(pane.selected>=idx){pane.selected--;this.getRef('pane'+pane.id).onResize(true);}})}}}},slashToHyphen(str){return bbn.fn.replaceAll('/','-',str);}},created(){this.componentClass.push('bbn-resize-emitter');this.$on('route',url=>{if(this.nav){this.setConfig();let i=this.history.indexOf(url);if(i>-1){this.history.splice(i,1);}
this.history.unshift(url);while(this.history.length>this.historyMaxLength){this.history.pop();}}});let storage=!this.single&&this.getStorage(this.parentContainer?this.parentContainer.getFullURL():this.storageName);if(storage&&storage.panes){bbn.fn.each(storage.panes,a=>{this.addPane(a.id,a.selected);})}},mounted(){this.parents=this.ancestors('bbn-router');this.parent=this.parents.length?this.parents[0]:false;this.router=this.parents.length?this.parents[this.parents.length-1]:this;if(this.parent){this.parentContainer=this.closest('bbn-container');let uri=this.parentContainer.url;if(this.root&&(uri!==this.root)&&(uri.indexOf(this.root)===0)){uri=this.root;}
this.baseURL=this.formatBaseURL(uri);}
else{if(!this.single&&db){bbn.db.open('bbn').then(r=>{this.db=r;},err=>{bbn.fn.log("Connection error in router",err);});}
window.addEventListener("beforeunload",e=>{e=e||window.event;if(this.isDirty){let st=bbn._('You have unsaved data, are you sure you want to leave?');if(e){e.returnValue=st;}
return st;}});}
let tmp=[];let storage=!this.single&&this.getStorage(this.parentContainer?this.parentContainer.getFullURL():this.storageName);if(storage){if(storage.breadcrumb!==undefined){this.isBreadcrumb=storage.breadcrumb;}
if(storage.visual!==undefined){this.isVisual=storage.visual;}
if(storage.orientation){this.visualOrientation=storage.orientation;this.lockedOrientation=true;}}
if(this.$slots.default){for(let node of this.$slots.default){if(node.componentOptions&&(node.componentOptions.tag==='bbn-container')){if(node.componentOptions.propsData.url===undefined){throw new Error(bbn._("You cannot use containers in router without defining a URL property"));}
if(!this.hasRealContainers){this.hasRealContainers=true;}
if(node.componentOptions.propsData.url===''){this.hasEmptyURL=true;}
let obj=bbn.fn.extend(true,{},node.componentOptions.propsData),props=node.componentOptions.Ctor.options.props;bbn.fn.iterate(props,(v,i)=>{if(!(i in obj)&&('default'in v)){obj[i]=v.default;}});bbn.fn.iterate(this.getDefaultView(),(a,n)=>{if(obj[n]===undefined){obj[n]=a;}});obj.real=true;tmp.push(obj);}}}
bbn.fn.each(this.source,(a,i)=>{if(a.url===''){if(a.load){throw new Error(bbn._("You cannot use containers with empty URL for loading"));}
this.hasEmptyURL=true;}
tmp.push(bbn.fn.extendOut(a,{real:false}));});if(storage&&storage.views){bbn.fn.each(storage.views,a=>{let idx=bbn.fn.search(tmp,{url:a.url});if(idx>-1){let isStatic=tmp[idx].static;bbn.fn.extend(tmp[idx],a,{static:isStatic});}
else{tmp.push(a);}});}
let url=this.getDefaultURL();if(this.first!=='real'){tmp=bbn.fn.multiorder(tmp,{real:'desc'});}
bbn.fn.each(tmp,a=>{if(!bbn.fn.isString(a.url)){throw new Error(bbn._("The container must have a valid URL"));}
if(url&&url.indexOf(a.url)===0){a.current=url;}
this.add(a);});if(this.splittable){bbn.fn.each(this.views,a=>{if(a.pane){let pane=bbn.fn.getRow(this.currentPanes,{id:a.pane});if(pane){pane.tabs.push(a);}}});}
if(!this.master&&this.parent&&this.parentContainer){this.parent.registerBreadcrumb(this);this.parentContainer.$on('view',()=>{this.parent.registerBreadcrumb(this);});this.parentContainer.$on('unview',()=>{this.parent.unregisterBreadcrumb(this);});if(this.parentContainer.isVisible){this.parent.registerBreadcrumb(this);}}
if(this.parentContainer){this.parentContainer.registerRouter(this);}
this.ready=true;if(!this.views.length){this.init(url);}},beforeDestroy(){if(!this.master&&this.parent){this.parent.unregisterBreadcrumb(this);}
if(this.parentContainer){this.parentContainer.unregisterRouter(this);}},watch:{visualShowAll(v){if(v&&this.isVisual){this.getRef('visualRouter').focus();}},selected(idx){if(this.views[idx]){bbn.fn.map(bbn.fn.filter(this.views,{selected:true}),a=>{if(a.idx!==idx){a.selected=false;}});if(!this.views[idx].selected&&!this.views[idx].pane){this.views[idx].selected=true;}
if(this.currentURL!==this.views[idx].current){this.route(this.views[idx].current);}}
else{throw new Error("The view with index "+idx+" doesn't exist");}},currentTitle(v){if(!this.parent){document.title=v+' - '+bbn.env.siteTitle;}},currentURL(newVal,oldVal){if(this.ready){this.$nextTick(()=>{let idx=this.search(newVal);if(idx!==false){let v=this.views[idx];let ct=this.urls[v.url];v.last=bbn.fn.timestamp();if(!v.pane){this.selected=idx;if(ct){this.changeURL(newVal,ct.title);}
else if(this.isLoading){this.changeURL(newVal,bbn._("Loading"));}}}
this.$emit('change',newVal);});this.$emit('route',newVal);}},url(newVal){if(this.ready){this.route(newVal);}},isDirty(v){if(this.parentContainer){this.parentContainer.dirty=v;}},itsMaster(newVal,oldVal){if(this.nav&&(newVal!==oldVal)){this.isBreadcrumb=newVal?newVal.isBreadcrumb:this.breadcrumb;if(this.breadcrumbWatcher){this.breadcrumbWatcher();}
if(newVal){this.breadcrumbWatcher=this.$watch('itsMaster.isBreadcrumb',isB=>{this.isBreadcrumb=isB;});}}},currentPanes:{deep:true,handler(){if(this.ready){this.setConfig();}}},isBreadcrumb(newVal){this.$nextTick(()=>{if(this.ready){this.setConfig();}})},isVisual(v){this.$nextTick(()=>{this.setConfig();})}},components:{listItem:{template:`
<div class="bbn-w-100 bbn-vmiddle bbn-bordered-bottom"
     style="height: 2.5em"
     @mouseenter="isHover = true"
     @mouseleave="isHover = false">
  <div class="bbn-flex-width bbn-vmiddle bbn-h-100">
    <div class="bbn-vmiddle bbn-h-100">
      <div v-for="(p, i) in source.parents"
           class="bbn-vmiddle bbn-h-100">
        <div class="bbn-vmiddle bbn-h-100"
            :style="{
              backgroundColor: !isHover && p.view.bcolor ? p.view.bcolor : null,
              color: !isHover && p.view.fcolor ? p.view.fcolor : null
            }">
          <div class="bbn-router-breadcrumb-badge-container bbn-middle"
              v-if="numProperties(p.view.events)">
            <span class="bbn-badge bbn-small bbn-bg-red"
                  v-text="numProperties(p.view.events)"/>
          </div>
          <div class="bbn-router-breadcrumb-loader bbn-border-text"
              :style="{borderColor: p.view.fcolor || null}"
              v-show="p.view.loading"/>
          <div :class="['bbn-router-breadcrumb-element', 'bbn-h-100', 'bbn-vmiddle', {'bbn-router-breadcrumb-dirty': p.view.dirty}]">
            <span v-if="p.view.icon"
                  :title="p.view.title"
                  :class="'bbn-router-breadcrumb-element-icon bbn-h-100 bbn-vmiddle bbn-right-xsspace' + (p.view.notext ? ' bbn-lg' : ' bbn-m')">
              <i :class="p.view.icon"/>
            </span>
            <span v-if="!p.view.notext"
                  class="bbn-router-breadcrumb-element-text"
                  :title="p.view.title && (p.view.title.length > p.maxTitleLength) ? p.view.title : ''"
                  v-html="p.view.title ? shortTitle(p) : '`+bbn._('Untitled')+`'"/>
          </div>
        </div>
        <div>
          <i class="nf nf-fa-angle_right bbn-hsmargin bbn-large bbn-router-breadcrumb-arrow"/>
        </div>
      </div>

      <div class="bbn-vmiddle bbn-h-100"
          :style="{
            backgroundColor: !isHover && source.view.bcolor ? source.view.bcolor : null,
            color: !isHover && source.view.fcolor ? source.view.fcolor : null
          }">
        <div class="bbn-router-breadcrumb-badge-container bbn-middle"
             v-if="numProperties(source.view.events)">
          <span class="bbn-badge bbn-small bbn-bg-red"
                v-text="numProperties(source.view.events)"/>
        </div>
        <div class="bbn-router-breadcrumb-loader bbn-border-text"
             :style="{borderColor: source.view.fcolor || null}"
             v-show="source.view.loading"/>
        <div :class="['bbn-router-breadcrumb-element', 'bbn-h-100', 'bbn-vmiddle', {'bbn-router-breadcrumb-dirty': source.view.dirty}]">
          <span v-if="source.view.icon"
                :title="source.view.title"
                :class="'bbn-router-breadcrumb-element-icon bbn-h-100 bbn-vmiddle bbn-right-xsspace' + (source.view.notext ? ' bbn-lg' : ' bbn-m')">
            <i :class="source.view.icon"/>
          </span>
          <span v-if="!source.view.notext"
                class="bbn-router-breadcrumb-element-text"
                :title="source.view.title && (source.view.title.length > source.maxTitleLength) ? source.view.title : ''"
                v-html="source.view.title ? (source.parents.length? shortTitle(source): source.view.title) : '`+bbn._('Untitled')+`'"/>
        </div>
      </div>

      <div v-for="(p, i) in source.children"
           class="bbn-vmiddle bbn-h-100">
        <div>
          <i class="nf nf-fa-angle_right bbn-hsmargin bbn-large bbn-router-breadcrumb-arrow"/>
        </div>
        <div class="bbn-vmiddle bbn-h-100"
             :style="{
               backgroundColor: !isHover && p.view.bcolor ? p.view.bcolor : null,
               color: !isHover && p.view.fcolor ? p.view.fcolor : null
             }">
          <div class="bbn-router-breadcrumb-badge-container bbn-middle"
              v-if="numProperties(p.view.events)">
            <span class="bbn-badge bbn-small bbn-bg-red"
                  v-text="numProperties(p.view.events)"/>
          </div>
          <div class="bbn-router-breadcrumb-loader bbn-border-text"
              :style="{borderColor: p.view.fcolor || null}"
              v-show="p.view.loading"/>
          <div :class="['bbn-router-breadcrumb-element', 'bbn-h-100', 'bbn-vmiddle', {'bbn-router-breadcrumb-dirty': p.view.dirty}]">
            <span v-if="p.view.icon"
                  :title="p.view.title"
                  :class="'bbn-router-breadcrumb-element-icon bbn-h-100 bbn-vmiddle bbn-right-xsspace' + (p.view.notext ? ' bbn-lg' : ' bbn-m')">
              <i :class="p.view.icon"/>
            </span>
            <span v-if="!p.view.notext"
                  class="bbn-router-breadcrumb-element-text"
                  :title="p.view.title && (p.view.title.length > p.maxTitleLength) ? p.view.title : ''"
                  v-html="p.view.title ? shortTitle(p) : '`+bbn._('Untitled')+`'"/>
             </div>
        </div>
      </div>
    </div>
    <div class="bbn-flex-fill bbn-h-100"
         :style="!isHover ? lastColors : {}">
      &nbsp;
    </div>
    <div v-if="!source.view.static"
          class="bbn-vmiddle bbn-h-100 bbn-hpadded"
          @click.prevent.stop="close"
          :style="!isHover ? lastColors : {}">
      <i class="nf nf-fa-times_rectangle bbn-lg"/>
    </div>
  </div>
</div>
        `,props:{source:{type:Object,required:true}},data(){return{isHover:false}},computed:{lastColors(){let e=this.source.children.length?this.source.children[this.source.children.length-1].view:this.source.view;let r={};if(e.bcolor){r.backgroundColor=e.bcolor;}
if(e.fcolor){r.color=e.fcolor;}
return r;}},methods:{numProperties:bbn.fn.numProperties,close(){let k=this.source.key;if(this.source.closeAction()){let list=this.closest('bbn-list');if(bbn.fn.isVue(list)){let idx=bbn.fn.search(list.source,{'data.key':k});if(idx>-1){list.source.splice(idx,1);if(list.source.length){list.updateData();this.$nextTick(()=>{list.closest('bbn-floater').onResize(true);})}
else{this.closest('bbn-floater').close();}}}}},shortTitle(src){return src.view.title.length>src.maxTitleLength?bbn.fn.shorten(src.view.title,src.maxTitleLength):src.view.title;}}},searchResult:{template:`
<div class="bbn-router-search-result bbn-w-100 bbn-spadded bbn-default-alt-background bbn-p bbn-hover-effect-element"
     :style="{backgroundColor: source.bcolor, color: source.fcolor}">
  <div class="bbn-flex-width">
    <div class="bbn-flex-fill bbn-nowrap">
      <span class="bbn-s bbn-badge bbn-bg-blue"
            v-text="source.score"/>
      <span v-text="_('Opened container')"/>
      <em v-text="'URL: ' + source.url"></em><br>
      <span class="bbn-lg" v-text="source.title"></span>
    </div>
    <div class="bbn-hlpadded bbn-h-100 bbn-r"
          style="vertical-align: middle"
          v-html="source.match">
    </div>
  </div>
</div>
`,props:{source:{type:Object,required:true}}}}});})(bbn,Vue);})(bbn);