((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div :class="[componentClass, {'bbn-textbox': !floating}, 'bbn-no-padding']"
   :style="{height: currentHeight}">
 <div v-if="floating"
      class="bbn-iflex-height"
    ref="container"
    style="min-height: 100%; width: 100%; overflow: visible">
  <div contenteditable="true"
       @focusin="isEditing = true"
     @input="updateContenteditable"
     class="bbn-rte-element"
     ref="element"/>
  <bbn-portal>
   <div v-show="isEditing">
    <bbn-floater :scrollable="false"
          ref="floater"
          @focusin="isEditing = true"
          :element="$el"
          position="topLeft"
          :title="false">
     <bbn-toolbar :source="currentButtons"
           class="bbn-rte-toolbar bbn-header bbn-radius-top bbn-no-border"
           :button-space="false"
           :disabled="disabled || readonly"/>
    </bbn-floater>
   </div>
  </bbn-portal>
 </div>
 <div v-else
      class="bbn-iflex-height"
    style="min-height: 100%; width: 100%;">
  <bbn-toolbar :source="currentButtons"
         class="bbn-rte-toolbar bbn-header bbn-radius-top bbn-no-border bbn-hspadded bbn-bottom-spadded"
         :button-space="false"
         :disabled="disabled || readonly"/>
  <div class="bbn-flex-fill"
     :style="textboxStyle"
     @mouseup.stop="getRef('element').focus()">
   <component :is="currentHeight ? 'bbn-scroll' : 'div'"
         :class="{'bbn-hidden': showSource}">
    <div class="bbn-spadded bbn-rte-element"
       style="min-height: max(4rem, 100%)"
       :contenteditable="!readonly && !disabled"
       ref="element"
       @paste="onPaste"
       @input="rteOnInput"
       @keydown="rteOnKeydown"
       @keyup="rteOnClick"
       @click="rteOnClick"/>
    <div class="bbn-hidden"
         ref="content">
     <slot></slot>
    </div>
    <textarea :required="required"
         :readonly="readonly"
         ref="input"
         :value="value"
         class="bbn-hidden"
         :disabled="isDisabled"/>
   </component>
   <div v-if="showSource"
      :class="{'bbn-overlay': !!currentHeight}">
    <bbn-code v-model="currentValue"
         mode="html"
         :fill="!!currentHeight"/>
   </div>
  </div>
 </div>
  <input type="file"
         ref="fileInput"
         class="bbn-rte-fileinput"
         @change="onFileInputChange"
         accept="image/*"/>
</div>`;script.setAttribute('id','bbn-tpl-component-rte');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);(()=>{"use strict";const defaultParagraphSeparatorString='defaultParagraphSeparator';const formatBlock='formatBlock';const queryCommandState=command=>document.queryCommandState(command);const queryCommandValue=command=>document.queryCommandValue(command);const setButtons=buttons=>{let res=[];if(!buttons.length){buttons=Object.keys(defaultButtons);}
bbn.fn.each(buttons,a=>{if(bbn.fn.isString(a)&&defaultButtons[a]){res.push(bbn.fn.extend({code:a},defaultButtons[a]));}
else{res.push(a);}});return res;};const exec=(command,value=null)=>document.execCommand(command,false,value);const defaultButtons={blockStyle:{text:bbn._('Style'),active:false,component:{name:'bbn-rte-style',template:`
          <bbn-dropdown class="bbn-rte-style"
                        :source="styles"
                        v-model="currentStyle"
                        :writable="false"
                        @change="setStyle"
                        :clear-html="true"/>
        `,data(){return{styles:[{text:bbn._('Normal'),value:'<div>'},{text:'<p>'+bbn._('Paragraph')+'</p>',value:'<p>'},{text:'<h1>'+bbn._('Heading 1')+'</h1>',value:'<h1>'},{text:'<h2>'+bbn._('Heading 2')+'</h2>',value:'<h2>'},{text:'<h3>'+bbn._('Heading 3')+'</h3>',value:'<h3>'},{text:'<h4>'+bbn._('Heading 4')+'</h4>',value:'<h4>'},{text:'<h5>'+bbn._('Heading 5')+'</h5>',value:'<h5>'},{text:'<h6>'+bbn._('Heading 6')+'</h6>',value:'<h6>'},{text:'<pre>'+bbn._('Preformatted')+'</pre>',value:'<pre>'},{text:'<blockquote>'+bbn._('Quote')+'</blockquote>',value:'<blockquote>'}],currentStyle:''}},methods:{setStyle(style){exec(formatBlock,style);}},mounted(){let rte=this.closest('bbn-rte')
rte.styleComponent=this;rte.setStyle();}}},fontsize:{text:bbn._('Font size'),active:false,component:{name:'bbn-rte-fontsize',template:`
          <bbn-dropdown class="bbn-rte-fontsize"
                        :source="sizes"
                        v-model="currentSize"
                        :writable="false"
                        @change="setSize"
                        :clear-html="true"
                        title="`+bbn._('Font size')+`"/>
        `,data(){return{sizes:[{text:'<font class="bbn-rte-fontsize-font" size="1">1</font>',value:1},{text:'<font class="bbn-rte-fontsize-font" size="2">2</font>',value:2},{text:'<font class="bbn-rte-fontsize-font" size="3">3</font>',value:3},{text:'<font class="bbn-rte-fontsize-font" size="4">4</font>',value:4},{text:'<font class="bbn-rte-fontsize-font" size="5">5</font>',value:5},{text:'<font class="bbn-rte-fontsize-font" size="6">6</font>',value:6},{text:'<font class="bbn-rte-fontsize-font" size="7">7</font>',value:7}],currentSize:''}},methods:{setSize(style){exec('fontSize',style);}},mounted(){let rte=this.closest('bbn-rte');rte.fontsizeComponent=this;rte.setFontsize();}}},fontincrease:{text:bbn._('Increase font size'),component:{template:`
          <bbn-button text="`+bbn._('Increase font size')+`"
                      icon="nf nf-fa-plus"
                      :notext="true"
                      @click="onClick"/>
        `,methods:{onClick(){let current=parseInt(queryCommandValue('fontSize'));if(current<7){exec('fontSize',current+1);let rte=this.closest('bbn-rte');if(rte){rte.setFontsize();}}}}},active:false},fontdecrease:{text:bbn._('Decrease font size'),component:{template:`
          <bbn-button text="`+bbn._('Decrease font size')+`"
                      icon="nf nf-fa-minus"
                      :notext="true"
                      @click="onClick"/>
        `,methods:{onClick(){let current=parseInt(queryCommandValue('fontSize'));if(current>1){exec('fontSize',current-1);let rte=this.closest('bbn-rte');if(rte){rte.setFontsize();}}}}},notext:true,active:false},bold:{icon:'nf nf-fa-bold',text:bbn._('Bold'),notext:true,active:false,action:()=>exec('bold')},italic:{icon:'nf nf-fa-italic',text:bbn._('Italic'),notext:true,active:false,action:()=>exec('italic')},underline:{icon:'nf nf-fa-underline',text:bbn._('Underline'),notext:true,active:false,action:()=>exec('underline')},strikethrough:{icon:'nf nf-fa-strikethrough',text:bbn._('Strike-through'),notext:true,active:false,action:()=>exec('strikeThrough')},align:{text:bbn._('Align'),notext:true,active:false,component:{name:'bbn-rte-align',template:`
          <bbn-radiobuttons :disabled="!!isDisabled || !!isReadOnly"
                            v-model="currentAlign"
                            :source="buttons"
                            :notext="true"
                            style="width: auto"
                            @input="setAlign"/>
        `,data(){return{buttons:[{text:bbn._('Align Left'),icon:'nf nf-fa-align_left',value:'justifyLeft'},{text:bbn._('Align Center'),icon:'nf nf-fa-align_center',value:'justifyCenter'},{text:bbn._('Align Right'),icon:'nf nf-fa-align_right',value:'justifyRight'},{text:bbn._('Align Justify'),icon:'nf nf-fa-align_justify',value:'justifyFull'}],currentAlign:'',isDisabled:false,isReadOnly:false}},methods:{setAlign(align){exec(align);}},mounted(){const rte=this.closest('bbn-rte');rte.alignComponent=this;this.isDisabled=!!rte.disabled;this.isReadOnly=!!rte.readonly;this.disWatch=rte.$watch('disabled',val=>this.isDisabled=!!val);this.readWatch=rte.$watch('readonly',val=>this.isDisabled=!!val);},beforeDestroy(){this.disWatch();this.readWatch();}}},fontcolor:{text:bbn._('Font Color'),notext:true,active:false,component:{name:'bbn-rte-fontcolor',template:`
          <span :class="['bbn-rte-fontcolor', 'bbn-vmiddle', 'bbn-iflex', 'bbn-bordered', 'bbn-radius', {
                  'disabled': !!isDisabled || !!isReadOnly,
                  'bbn-background': !isDisabled && !isReadOnly
                }]">
            <i class="nf nf-mdi-format_color_text bbn-hxsspace"/>
            <bbn-colorpicker @change="setColor"
                             v-model="currentColor"
                             :disabled="isDisabled"
                             :readonly="isReadOnly"/>
          </span>
        `,data(){return{currentColor:bbn.fn.rgb2hex(window.getComputedStyle(document.body).color),isDisabled:false,isReadOnly:false}},methods:{setColor(color){exec('foreColor',color);}},mounted(){const rte=this.closest('bbn-rte');rte.fontColorComponent=this;this.isDisabled=!!rte.disabled;this.isReadOnly=!!rte.readonly;this.disWatch=rte.$watch('disabled',val=>this.isDisabled=!!val);this.readWatch=rte.$watch('readonly',val=>this.isDisabled=!!val);},beforeDestroy(){this.disWatch();this.readWatch();}}},fontbgcolor:{text:bbn._('Font Background Color'),notext:true,active:false,component:{name:'bbn-rte-fontbgcolor',template:`
        <span :class="['bbn-rte-fontbgcolor', 'bbn-vmiddle', 'bbn-iflex', 'bbn-bordered', 'bbn-radius', {
                'disabled': !!isDisabled || !!isReadOnly,
                'bbn-background': !isDisabled && !isReadOnly
              }]">
            <i class="nf nf-mdi-format_color_fill bbn-hxsspace bbn-lg"/>
            <bbn-colorpicker @change="setColor"
                             v-model="currentColor"
                             :disabled="isDisabled"
                             :readonly="isReadOnly"/>
          </span>
        `,data(){return{currentColor:'',isDisabled:false,isReadOnly:false}},methods:{setColor(color){exec('hiliteColor',color);}},mounted(){const rte=this.closest('bbn-rte');rte.fontBgColorComponent=this;this.isDisabled=!!rte.disabled;this.isReadOnly=!!rte.readonly;this.disWatch=rte.$watch('disabled',val=>this.isDisabled=!!val);this.readWatch=rte.$watch('readonly',val=>this.isDisabled=!!val);},beforeDestroy(){this.disWatch();this.readWatch();}}},outdent:{icon:'nf nf-md-arrow_expand_left',text:bbn._('Decrease indent'),notext:true,action:()=>exec('outdent')},indent:{icon:'nf nf-md-arrow_expand_right',text:bbn._('Increase indent'),notext:true,action:()=>exec('indent')},quote:{icon:'nf nf-mdi-format_quote_open',text:bbn._('Quote'),notext:true,action:()=>exec('formatBlock','<blockquote>')},olist:{icon:'nf nf-mdi-format_list_numbers',text:bbn._('Ordered List'),notext:true,action:()=>exec('insertOrderedList')},ulist:{icon:'nf nf-mdi-format_list_bulleted_type',text:bbn._('Unordered List'),notext:true,action:()=>exec('insertUnorderedList')},code:{icon:'nf nf-mdi-code_tags',text:bbn._('Code'),notext:true,action:()=>exec('formatBlock','<pre>')},line:{icon:'nf nf-oct-horizontal_rule',text:bbn._('Horizontal Line'),notext:true,action:()=>exec('insertHorizontalRule')},link:{icon:'nf nf-oct-link',text:bbn._('Link'),notext:true,action:()=>{const url=window.prompt(bbn._('Enter the link URL'))
if(url)exec('createLink',url)}},image64:{text:bbn._('Image'),component:{template:`
          <bbn-button text="`+bbn._('Image')+`"
                      icon="nf nf-md-image_plus"
                      :notext="true"
                      @click="onClick"/>
        `,methods:{onClick(){let rte=this.closest('bbn-rte');if(rte){let fileInput=rte.getRef('fileInput');if(fileInput){fileInput.click();}}}}},notext:true},image:{icon:'nf nf-md-image_move',text:bbn._('Image from URL'),notext:true,action:()=>{const url=window.prompt(bbn._('Enter the image URL'))
if(url)exec('insertImage',url)}}};const defaultStates={bold:{active:()=>queryCommandState('bold'),},italic:{active:()=>queryCommandState('italic'),},underline:{active:()=>queryCommandState('underline'),},strikethrough:{active:()=>queryCommandState('strikeThrough'),},};const defaultClasses={actionbar:'pell-actionbar',button:'pell-button',content:'pell-content',selected:'pell-button-selected'};let openedFloatingRTE=[];Vue.component('bbn-rte',{mixins:[bbn.vue.basicComponent,bbn.vue.inputComponent,bbn.vue.eventsComponent],props:{toolbar:{type:Boolean,default:true},position:{type:String,default:'top'},iFrame:{type:Boolean,default:false},iframeCSSLinks:{default(){return[bbn.env.cdn+'lib/bbnjs/1.0.1/src/css/iFrame.less']},type:Array},height:{type:[String,Number]},cleanPaste:{type:Boolean,default:false},buttons:{type:Array,default(){return[];}},cfg:{type:Object,default:function(){return{pinned:true,top:null,left:null,bottom:5,right:5,}}},floating:{type:Boolean,default:false}},data(){return{realHeight:typeof this.height==='string'?this.height:this.height+'px',widget:false,currentValue:this.value,fontColorComponent:null,fontBgColorComponent:null,fontsizeComponent:null,alignComponent:null,isEditing:false,showSource:false,body:document.body}},computed:{textboxStyle(){let style={};if(this.toolbar){if(this.position==='top'){style.borderTop='0px';style.borderTopLeftRadius='0px';style.borderTopRightRadius='0px';}
else{style.borderBottom='0px';style.borderBottomLeftRadius='0px';style.borderBottomRightRadius='0px';}}
return style;},currentHeight(){if(!!this.height){return bbn.fn.isNumber(this.height)&&(this.height>0)?this.height+'px':this.height;}
return'';}},methods:{onPaste(ev){if(this.cleanPaste){ev.preventDefault();bbn.fn.replaceSelection(bbn.fn.nl2br(ev.clipboardData.getData('text/plain').trim(),true));this.emitInput(this.getRef('element').innerHTML);}},setButtons(){let tmp=setButtons(this.buttons);if(this.floating){tmp.push({icon:'nf nf-fa-times',text:bbn._('Close'),notext:true,active:false,action:()=>{this.isEditing=false;}});}
let row=bbn.fn.getRow(tmp,{code:'code'});if(row){row.action=()=>{this.showSource=!this.showSource;}}
this.currentButtons=tmp;},updateButtonsState(){bbn.fn.iterate(this.currentStates,(a,n)=>{let row=bbn.fn.getRow(this.currentButtons,{code:n});if(row){row.active=a.active();}});},rteOnKeydown(event){if(event.key==='Enter'){event.stopPropagation();event.stopImmediatePropagation();}
if(event.key==='Enter'&&queryCommandValue(formatBlock)==='blockquote'){setTimeout(()=>exec(formatBlock,`<${this.defaultParagraphSeparator}>`),0);}
this.setColors();this.setStyle();this.setAlign();},rteOnClick(event){this.updateButtonsState();this.setColors();this.setStyle();this.setFontsize();this.setAlign();},rteOnInput(target){let firstChild=target.firstChild;if(firstChild&&firstChild.nodeType===3){exec(formatBlock,`<${this.defaultParagraphSeparator}>`);}
else if(this.content.innerHTML==='<br>'){this.content.innerHTML=''}
this.updateButtonsState();this.currentValue=this.content.innerHTML;this.emitInput(this.currentValue);},setStyle(){if(this.styleComponent){let style=queryCommandValue(formatBlock);this.styleComponent.currentStyle=!!style?`<${style}>`:'<div>';}},setColors(){if(this.fontColorComponent){this.fontColorComponent.currentColor=bbn.fn.rgb2hex(queryCommandValue('foreColor'));}
if(this.fontBgColorComponent){this.fontBgColorComponent.currentColor=bbn.fn.rgb2hex(queryCommandValue('hiliteColor'));if(!this.fontBgColorComponent.currentColor){this.fontBgColorComponent.currentColor=bbn.fn.rgb2hex(queryCommandValue('backColor'));}}},setFontsize(){if(this.fontsizeComponent){this.fontsizeComponent.currentSize=parseInt(queryCommandValue('fontSize'))||2;}},setAlign(){if(this.alignComponent){let current;if(queryCommandState('justifyLeft')){current='justifyLeft';}
else if(queryCommandState('justifyCenter')){current='justifyCenter';}
else if(queryCommandState('justifyRight')){current='justifyRight';}
else if(queryCommandState('justifyFull')){current='justifyFull';}
if(!!current&&(this.alignComponent.currentAlign!=current)){this.alignComponent.currentAlign=current;}}},onClickDocument(e){let floater=this.getRef('floater');let element=this.getRef('element');if(floater&&element){if(!bbn.fn.isInside(e.target,floater.$el)&&!bbn.fn.isInside(e.target,element)&&(e.target!==element)){bbn.fn.log("onClickDocument");this.isEditing=false;}}},updateContenteditable(){let element=this.getRef('element');let st=element.innerHTML;if(st!==this.currentValue){this.currentValue=st;this.emitInput(st);}},stopEdit(){if(bbn.fn.isNumber(this.stopEditTimeout)){clearTimeout(this.stopEditTimeout);}
this.stopEditTimeout=setTimeout(()=>{this.isEditing=false;},2000)},onFileInputChange(ev){const files=ev.target.files;if(files.length){const[file]=files;const fileReader=new FileReader();fileReader.onload=()=>{const img=fileReader.result;exec('insertHTML',`<img src="${img}" style="max-width: 100%; height: auto; object-fit: scale-down">`);this.getRef('fileInput').value='';}
fileReader.readAsDataURL(file);}}},created(){if(!this.value&&this.$slots.default&&this.$slots.default[0]&&this.$slots.default[0].text.length){this.currentValue=this.$slots.default[0].text;}
this.setButtons();this.defaultParagraphSeparator=this[defaultParagraphSeparatorString]||'div'},mounted(){let cfg={iframe:this.iFrame,disabled:this.isDisabled,readonly:this.readonly,required:this.required,allowResizeX:false,allowResizeY:false,spellcheck:false,useSplitMode:true,height:this.height,tabIndex:0,maxHeight:'100%',uploader:{insertImageAsBase64URI:true},iframeCSSLinks:this.iFrame?this.iframeCSSLinks:[]};this.content=this.getRef('element');this.content.innerHTML=this.currentValue;this.ready=true;},beforeDestroy(){if(this.floating){window.document.body.removeEventListener('click',this.onClickDocument);}},watch:{value(v){if(v!==this.currentValue){this.currentValue=v;this.content.innerHTML=v;}},currentValue(v){if(this.showSource){this.content.innerHTML=v;}},buttons:{deep:true,handler(){this.setButtons();}},isEditing(v){if(this.floating){if(v){window.document.body.addEventListener('click',this.onClickDocument);this.$nextTick(()=>{this.getRef('floater').onResize(true);})}
else{window.document.body.removeEventListener('click',this.onClickDocument);}
this.$forceUpdate();}}}});})();})(bbn);