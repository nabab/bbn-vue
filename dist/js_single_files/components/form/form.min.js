((bbn)=>{let script=document.createElement('script');script.innerHTML=`<form :action="action"
      :disabled="disabled"
      :method="method"
      :autocomplete="autocomplete"
      :class="currentClass"
      :style="currentStyle"
      @submit.prevent
      @keydown.enter.prevent.stop="submit"
      @keyup.esc="cancel"
>
  <div :class="{
         'bbn-flex-fill': isInit && scrollable || !!fullSize,
         'bbn-w-100': scrollable,
         'bbn-flex-height': !scrollable && hasFooter
       }"
  >
    <component :is="scrollable ? 'bbn-scroll' : 'div'"
               :class="{'bbn-overlay': !!fullSize}"
               ref="container"
    >
      <div class="bbn-grid-fields bbn-padded" v-if="schema && schema.length">
        <template v-for="field in currentSchema"
                  v-if="field.field && !field.buttons && (field.editable !== false)"
        >
          <component v-if="field.lineComponent"
                     :is="field.lineComponent"
                     :source="source"
          ></component>
          <template v-else>
            <label v-html="field.title"
                   :for="field.id"
                   :title="field.ftitle || field.title || field.field"
            ></label>
            <component v-if="field.editor"
                       :is="field.editor"
                       v-bind="field.options"
                       v-model="source[field.field]"
            ></component>
            <bbn-field v-else
                       mode="write"
                       v-bind="field"
                       v-model="source[field.field]"
            ></bbn-field>
          </template>
        </template>
      </div>
      <slot></slot>
    </component>
  </div>
  <div v-if="hasFooter && !popup"
       class="bbn-form-footer bbn-header"
  >
    <slot name="footer"></slot>
  </div>
  <div v-else-if="!window && realButtons.length"
       class="bbn-form-footer bbn-popup-footer bbn-button-group bbn-flex-width bbn-lg"
  >
    <bbn-button v-for="(button, i) in realButtons"
                :key="i"
                v-bind="button"
    ></bbn-button>
  </div>
</form>`;script.setAttribute('id','bbn-tpl-component-form');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);(function(bbn){"use strict";Vue.component('bbn-form',{mixins:[bbn.vue.basicComponent,bbn.vue.localStorageComponent],props:{autofocus:{type:Boolean,default(){return!bbn.fn.isMobile()}},autocomplete:{type:Boolean,default:false},prefilled:{type:Boolean,default:false},disabled:{},script:{},fields:{},blank:{type:Boolean,default:false},self:{type:Boolean,default:false},target:{type:String},confirmMessage:{type:[String,Function]},confirmLeave:{type:[Boolean,String,Function],default:bbn._("Are you sure you want to discard the changes you made in this form?")},action:{type:String},success:{type:Function},failure:{type:Function},successMessage:{type:[String,Function]},failureMessage:{type:[String,Function]},method:{type:String,default:'post'},scrollable:{type:Boolean,default:false},buttons:{type:[Boolean,Array],default(){return['cancel','submit'];}},submitText:{type:String,default:bbn._('Submit')},cancelText:{type:String,default:bbn._('Cancel')},resetText:{type:String,default:bbn._('Reset')},source:{type:Object,default(){return{}}},data:{type:Object},fixedFooter:{type:Boolean,default:false},schema:{type:Array,default:function(){return[];}},sendModel:{type:Boolean,default:true},validation:{type:Function},windowed:{type:[Boolean,String],default:'auto'},fullSize:{type:Boolean,default:false}},data(){let currentSchema=[];this.schema.map((a)=>{currentSchema.push(bbn.fn.extend({},a,{id:a.id?a.id:bbn.fn.randomString(20,30)}))});return{dirty:false,popupIndex:false,tab:false,originalData:bbn.fn.clone(this.source),isPosted:false,isLoading:false,currentSchema:currentSchema,_isSetting:false,window:null,isInit:false,realButtons:[],canSubmit:false,sourceTimeout:0};},computed:{hasFooter(){return this.$slots.footer&&this.$slots.footer.length;},canCancel(){return this.window||this.isModified();},currentClass(){let st=this.componentClass.join(' ');if(this.isInit){if(this.window){st+=' bbn-flex-height';}
else if((this.hasFooter||this.realButtons.length||this.footer)&&(this.scrollable||this.fullSize)){st+=' bbn-flex-height';}
if(this.scrollable||this.fullSize){st+=' bbn-overlay';}}
return st;},currentStyle(){return{};if(!this.isInit){return{};}
let floater=this.closest('bbn-floater');let ct=this.getRef('container');let ctn=ct?ct.getRef('scrollContent'):false;if(floater&&ct){let width=this.scrollable&&ctn?ctn.clientWidth:ct.clientWidth;let height=this.scrollable&&ctn?ctn.clientHeight:ct.clientHeight;let ctWidth=floater.getContainerWidth();let ctHeight=floater.getContainerHeight()-(floater.getRef('header').clientHeight||0);if(width>ctWidth){width=ctWidth;}
if(height>ctHeight){height=ctHeight;}
return{width:width+'px',height:height+'px'};}}},methods:{_canSubmit(){return(this.prefilled||this.isModified())&&this.isValid(false,false);},getRealButtons(){let r=[];if(this.buttons){bbn.fn.each(this.buttons.slice(),(a)=>{let t=typeof(a);if(t==='string'){switch(a){case'cancel':r.push({text:this.cancelText,icon:'nf nf-fa-times_circle',action:()=>{this.cancel();},disabled:!this.canCancel});break;case'reset':r.push({text:this.resetText,icon:'nf nf-fa-refresh',action:()=>{this.reset();},disabled:!this.dirty&&!this.prefilled});break;case'submit':r.push({text:this.submitText,icon:'nf nf-fa-check_circle',action:()=>{this.submit();},disabled:!this.canSubmit});break;}}
else if(t==='object'){if((typeof a.action==='string')&&bbn.fn.isFunction(this[a.action])){a.action=this[a.action];}
r.push(a);}});}
return r;},_post(){this.isPosted=true;this.isLoading=true;if(this.action){this[this.blank||this.self||this.target?'postOut':'post'](this.action,bbn.fn.extend(true,{},this.data||{},this.source||{}),(d)=>{this.originalData=bbn.fn.extend(true,{},this.source||{});if(this.successMessage&&p){p.alert(this.successMessage);bbn.fn.info(this.successMessage,p);}
let e=new Event('success',{cancelable:true});if(this.sendModel&&this.source){this.originalData=bbn.fn.extend(true,{},this.source||{});}
this.dirty=false;this.isLoading=false;this.$emit('success',d,e);if(!e.defaultPrevented){if(this.window){this.window.close(true);}}},!this.blank&&!this.self&&!this.target?(xhr,textStatus,errorThrown)=>{this.$emit('failure',xhr,textStatus,errorThrown);this.isLoading=false;}:(this.self?'_self':(this.blank?'_blank':this.target)));}
else{this.originalData=bbn.fn.clone(this.source);let e=new Event('success',{cancelable:true});this.$emit('success',this.source,e);if(this.sendModel){this.originalData=bbn.fn.clone(this.source);}
this.dirty=false;this.isLoading=false;if(!e.defaultPrevented){if(this.window){this.window.close(true);}}}},_execCommand(button,ev){if(button.action){button.action(this.source,this,ev)}},updateButtons(){if(this.buttons===false){return;}
if(this.realButtons.length){this.realButtons.splice(0,this.realButtons.length);}
if(this.window&&bbn.fn.isArray(this.window.currentButtons)){this.window.currentButtons.splice(0,this.window.currentButtons.length);}
bbn.fn.each(this.getRealButtons(),b=>{this.realButtons.push(b);if(this.window&&bbn.fn.isArray(this.window.currentButtons)){this.window.currentButtons.push(b);}});},getModifications(){let data=this.getData(this.$el)||{},res={};for(let n in data){if((this.sendModel&&(data[n]!==this.originalData[n]))||(!this.sendModel&&(data[n]!=this.originalData[n]))){res[n]=data[n];}}
return res;},getData(){return this.source;},isModified(){if(!bbn.fn.isSame(this.source,this.originalData)){return true;}
return false;},closePopup(window,ev){if(this.window&&this.$el){if(!this.isPosted&&this.confirmLeave&&this.isModified()){if(ev){ev.preventDefault();}
this.getPopup().confirm(this.confirmLeave,()=>{if(this.reset()){this.$nextTick(()=>{if(this.window){this.window.close(true,true);}});}});}
else{if(this.reset()){this.$nextTick(()=>{if(this.window){this.window.close(true,true);}});}}}},cancel(){let ev=new Event('cancel',{cancelable:true});this.$emit('cancel',ev,this);if(!ev.defaultPrevented){if(this.window){this.window.close();}
else if(!bbn.fn.getRow(this.realButtons,{text:bbn._('Reset')})){this.reset();}}},isValid(force,callValidation=true){let ok=true;let elems=this.findAll('.bbn-input-component');if(Array.isArray(elems)){bbn.fn.each(elems,(a)=>{if(bbn.fn.isFunction(a.isValid)&&!a.isValid(a,false)){ok=false;}
else if(bbn.fn.isFunction(a.validation)&&!a.validation()){ok=false;}
if(!ok){return false;}});}
if(ok&&this.validation&&callValidation){ok=this.validation(this.source,this.originalData,force)}
return!!ok;},submit(force){if(!this.isValid(force)){return;}
if(!force){let ev=new Event('submit',{cancelable:true});this.$emit('submit',ev,this);if(ev.defaultPrevented){return;}}
let cf=false;if(this.confirmMessage){if(bbn.fn.isFunction(this.confirmMessage)){cf=this.confirmMessage(this);}
else{cf=this.confirmMessage;}
if(cf&&this.window){this.window.confirm(cf,()=>{this._post();});}}
if(!cf){this._post();}},reset(){this.isPosted=false;bbn.fn.iterate(this.originalData,(val,name)=>{if(!bbn.fn.isSame(this.source[name],val)){if(typeof val!==typeof this.source[name]){this.$set(this.source,name,bbn.fn.clone(val));}
else if(bbn.fn.isArray(this.source[name],val)){bbn.fn.each(val,(a,i)=>{if(this.source[name].length<=i){this.source[name].push(a);}
else if(a!==this.source[name][i]){let idx=this.source[name].indexOf(a);if(idx>i){bbn.fn.move(this.source[name],idx,i);}
else{this.source[name].splice(i,0,a);}}});if(this.source[name].length>val.length){this.source[name].splice(val.length,this.source[name].length-val.length);}}
else if(bbn.fn.isObject(this.source[name],val)){let k1=Object.keys(val);let k2=Object.keys(this.source[name]);bbn.fn.each(k2,a=>{if(k1.indexOf(a)===-1){delete this.source[name][a];}});bbn.fn.each(k1,a=>{if(val[a]!==this.source[name][a]){this.source[name][a]=val[a];}});}
else{this.$set(this.source,name,bbn.fn.clone(val));}}});this.$forceUpdate();return true;},reinit(){this.originalData=JSON.parse(JSON.stringify(this.source));this.dirty=this.isModified();},focusFirst(fromLast){let ele=this.getRef('container');if(this.scrollable){ele=ele.$el;}
if(ele){let focusable=false;let all=ele.querySelectorAll('input, select, .bbn-checkbox-label, textarea, [tabindex]:not([tabindex="-1"])');if(fromLast){bbn.fn.forir(all,(a)=>{if(a.offsetHeight&&a.offsetWidth&&!a.disabled&&!a.classList.contains('bbn-no')){focusable=a;return false;}})}
else{bbn.fn.each(all,(a)=>{if(a.offsetHeight&&a.offsetWidth&&!a.disabled&&!a.classList.contains('bbn-no')){bbn.fn.log(a);focusable=a;return false;}});}
if(focusable){focusable.focus();}}},focusLast(){bbn.fn.log("focusLast");this.focusFirst(true);},init(){if(this.$options.propsData.script){this.$el.dataset.script=this.$options.propsData.script;}
this.$nextTick(()=>{let focusable=null;if(!this.window&&this.windowed){this.window=this.closest("bbn-floater");if(this.window){this.window.addClose(this.closePopup);}}
this.updateButtons();if(!this.tab){this.tab=this.closest("bbn-container");}
if(this.autofocus){this.focusFirst();}
this.canSubmit=this._canSubmit();this.isInit=true;});},checkValidity(){return this.$el.checkValidity();},reportValidity(){return this.$el.reportValidity();}},mounted(){if(this.storage){let data=this.getStorage();if(data){this._isSetting=true;bbn.fn.iterate(data,(val,name)=>{if(!bbn.fn.isSame(this.source[name],val)){if(typeof val!==typeof this.source[name]){this.$set(this.source,name,bbn.fn.clone(val));}
else if(bbn.fn.isArray(this.source[name],val)){bbn.fn.each(val,(a,i)=>{if(this.source[name].length<=i){this.source[name].push(a);}
else if(a!==this.source[name][i]){let idx=this.source[name].indexOf(a);if(idx>i){bbn.fn.move(this.source[name],idx,i);}
else{this.source[name].splice(i,0,a);}}});if(this.source[name].length>val.length){this.source[name].splice(val.length,this.source[name].length-val.length);}}
else if(bbn.fn.isObject(this.source[name],val)){let k1=Object.keys(val);let k2=Object.keys(this.source[name]);bbn.fn.each(k2,a=>{if(k1.indexOf(a)===-1){delete this.source[name][a];}});bbn.fn.each(k1,a=>{if(val[a]!==this.source[name][a]){this.source[name][a]=val[a];}});}
else{this.$set(this.source,name,bbn.fn.clone(val));}}});this._isSetting=false;this.canSubmit=this._canSubmit();this.$forceUpdate();}}
this.init();},beforeDestroy(){if(this.dirty){if(this.window){this.window.dirty=false;}
if(this.tab){this.tab.dirty=false;}}},watch:{schema(){let currentSchema=[];this.schema.map((a)=>{currentSchema.push(bbn.fn.extend({},a,{id:a.id?a.id:bbn.fn.randomString(20,30)}))});this.currentSchema=currentSchema;},source:{deep:true,handler(){bbn.fn.warning('form changed')
this.dirty=this.isModified();if(this.storage){if(!this._isSetting){this.setStorage(this.source)}}
this.$emit('change',this.getModifications())
this.$nextTick(()=>{if(this.sourceTimeout){clearTimeout(this.sourceTimeout);}
this.sourceTimeout=setTimeout(()=>{this.canSubmit=this._canSubmit();},200)})}},buttons:{deep:true,handler(){if(this.isInit){this.updateButtons();}}},canSubmit(){this.updateButtons();},canCancel(){this.updateButtons();},dirty(v){if(this.window){this.window.dirty=v;}
if(this.tab){this.tab.dirty=v;}}}});})(bbn);})(bbn);