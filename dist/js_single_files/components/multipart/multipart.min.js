((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div class="bbn-overlay bbn-flex-height bbn-form">
  <div class="bbn-flex-fill"
       v-for="(part, i) in parts"
       v-show="currentSelected === i"
       :key="i">
    <bbn-form :source="data"
              :buttons="false"
              :ref="'form-' + i"
              :prefilled="true"
              @ready="readyForm = true"
              @success="currentSelected === maxIndex ? onSuccess() : false"
              :action="currentSelected === maxIndex ? action : ''"
              :target="currentSelected === maxIndex ? target : ''">
      <div :class="['bbn-overlay', {
        'bbn-middle': centered,
        'bbn-padded': !centered
      }]">
        <div :class="['bbn-grid-fields', {
               'bbn-block': !!centered,
               'bbn-padded': !centered
             }]"
             style="max-height: 100%">
          <template v-for="(item, ii) in part.items">
            <div class="bbn-label"
                 v-text="item.title || item.name"/>
            <div class="bbn-block"
                 :style="item.style">
              <div class="bbn-h-100">
                <component :is="item.component || 'bbn-input'"
                            v-bind="item.getOptions()"
                            @keydown.enter.prevent.stop="clickNext()"
                            :required="item.required === undefined ? true : item.required"
                            v-model="data[item.name]"/>
              </div>
            </div>
          </template>
        </div>
      </div>
    </bbn-form>
  </div>
  <div class="bbn-form-footer bbn-popup-footer bbn-button-group bbn-flex-width bbn-lg">
    <bbn-button v-for="(button, i) in currentButtons"
                :key="button.key"
                v-bind="button"/>
  </div>
</div>
`;script.setAttribute('id','bbn-tpl-component-multipart');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);(function(bbn){"use strict";Vue.component('bbn-multipart',{mixins:[bbn.vue.basicComponent,bbn.vue.localStorageComponent,bbn.vue.inputComponent],props:{source:{type:Array,required:true},value:{type:Object,default(){return{};}},autocomplete:{type:Boolean,default:false},disabled:{},script:{},scrollable:{},blank:{type:Boolean,default:false},self:{type:Boolean,default:false},target:{type:String},confirmMessage:{type:[String,Function]},confirmLeave:{type:[Boolean,String,Function],default:bbn._("Are you sure you want to discard the changes you made in this form?")},action:{type:String},success:{type:Function},failure:{type:Function},successMessage:{type:[String,Function]},failureMessage:{type:[String,Function]},method:{type:String,default:'post'},buttons:{type:[Boolean,Array],default(){return['cancel','submit'];}},validation:{type:Function},windowed:{type:[Boolean,String],default:'auto'},fullSize:{type:Boolean,default:false},centered:{type:Boolean,default:true},closable:{type:Boolean,default:false}},data(){let data={};let parts=[];if(bbn.fn.isArray(this.source)){bbn.fn.each(this.source,part=>{let items=[];let indexes=[];part=bbn.fn.clone(part);if(!bbn.fn.isArray(part)){part=[part];}
bbn.fn.each(part,a=>{if(a.name){indexes.push(a.name);a.getOptions=()=>{if(bbn.fn.isFunction(a.options)){return a.options(this.data);}
return a.options||{};};if(a.centered===undefined){a.centered=this.centered;}
items.push(a);if(a.value===undefined){if(a.default){data[a.name]=bbn.fn.isFunction(a.default)?a.default():a.default}
else{data[a.name]=a.nullable?null:''}}
else{data[a.name]=a.value;}}})
if(items.length){parts.push({items:items,indexes:indexes});}})}
return{root:appui.plugins['appui-menu']+'/',cf:null,data:data,parts:parts,currentSelected:0,indexes:Object.keys(data),readyForm:false,currentButtons:false,maxIndex:parts.length-1,isValidated:false}},methods:{clickPrev(){if(this.currentSelected){this.currentSelected--;}},clickNext(){if(!this.isValidated){return;}
let form=this.getRef('form-'+this.currentSelected);if(!form){return;}
if(this.parts[this.currentSelected+1]){this.currentSelected++;}
else if(this.action){this.$emit('submit',this.data);form.submit();}},getCurrentForm(){return this.getRef('form-'+this.currentSelected);},hasForm(){return!!this.getCurrentForm();},getButtons(){let form=this.hasForm();if(!form){this.readyForm=false;}
if(this.parts[this.currentSelected]){let ret=[];if((this.currentSelected===0)&&this.closable){ret.push({text:bbn._("Cancel"),action:()=>{let form=this.getCurrentForm();if(form){form.closePopup();}},key:bbn.fn.randomString()});}
else{ret.push({text:bbn._("Back"),action:this.clickPrev,disabled:!form||(this.currentSelected===0),key:bbn.fn.randomString()});}
ret.push({text:this.currentSelected===this.maxIndex?bbn._("Confirm"):bbn._("Next"),action:this.clickNext,disabled:!form||!this.isValidated,key:bbn.fn.randomString()});return ret;}
return false;},onSubmit(){bbn.fn.log(arguments);},updateButtons(){setTimeout(()=>{let form=this.getRef('form-'+this.currentSelected);if(form){this.isValidated=form.isValid();bbn.fn.log("FOR VALUID?",this.isValidated);this.currentButtons=this.getButtons()
this.$forceUpdate();this.$nextTick(()=>{this.$forceUpdate()})}
else{this.readyForm=false;this.isValidated=false;}},50)},onSuccess(){bbn.fn.log("SUCCESS",arguments,this.data)}},created(){this.currentButtons=this.getButtons(this.currentSelected);},mounted(){this.ready=true;},watch:{currentSelected(){this.isValidated=false;this.updateButtons();},readyForm(v){this.updateButtons();},data:{deep:true,handler(){this.updateButtons();}}}});})(bbn);})(bbn);