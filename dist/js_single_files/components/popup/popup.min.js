((bbn)=>{let script=document.createElement('script');script.innerHTML=`<div :class="['bbn-overlay', componentClass]"
     v-show="showPopup"
     @subready.stop
     :style="{zIndex: zIndex}"
     v-if="ready"
>

  <bbn-floater v-for="(popup, i) in popups"
               :key="popup.uid"
               :ref="popup.uid"
               :index="popup.index"
               v-bind="popup"
               :container="$el"
               :style="{zIndex: zIndex+i}"
               @close="onClose(i)"/>
  <div class="bbn-modal bbn-overlay"
      tabindex="-1"
      :style="{zIndex: zIndex+items.length-2}"
      @keydown.esc.prevent.stop="close(items.length-1)"
      v-if="popups.length && (popups[popups.length - 1].modal !== false)"
  ></div>
</div>
`;script.setAttribute('id','bbn-tpl-component-popup');script.setAttribute('type','text/x-template');document.body.insertAdjacentElement('beforeend',script);(function(bbn){"use strict";Vue.component('bbn-popup',{mixins:[bbn.vue.basicComponent,bbn.vue.resizerComponent],props:{defaultWidth:{type:[String,Number],default:'70%'},defaultHeight:{type:[String,Number],default:'70%'},untitled:{type:String,default:bbn._("Untitled")},source:{type:Array,default:function(){return[];}},zIndex:{type:Number,default:10},alertMessage:{type:String,default:bbn._("There was a problem")+'...'},confirmTitle:{type:String,default:bbn._("Confirmation request")},confirmMessage:{type:String,default:bbn._("Are you sure?")},okText:{type:String,default:bbn._("OK")},yesText:{type:String,default:bbn._("Yes")},noText:{type:String,default:bbn._("No")}},data:function(){return{type:false,items:this.source};},computed:{numPopups(){return this.items.length},popups(){let r=[];bbn.fn.each(this.items,(a,i)=>{r.push(this.getObject(bbn.fn.extend({},a,{index:i,maxWidth:a.maxWidth||this.lastKnownWidth||this.lastKnownCtWidth||null,maxHeight:a.maxHeight||this.lastKnownHeight||this.lastKnownCtHeight||null})));});return r;},showPopup(){return this.items.length>0;}},methods:{randomString:bbn.fn.randomString,open(obj){let d={};if(typeof(obj)!=='object'){for(let i=0;i<arguments.length;i++){if(!d.content&&(typeof(arguments[i])==='string')){d.content=arguments[i];}
else if(bbn.fn.isDimension(arguments[i])){if(!d.width){d.width=arguments[i];}
else if(!d.height){d.height=arguments[i];}}
else if(!d.title&&(typeof(arguments[i])==='string')){d.title=arguments[i];}
else if(!d.title&&(arguments[i]===false)){d.title=false;}
else if(bbn.fn.isFunction(arguments[i])){if(!d.onOpen){d.onOpen=arguments[i];}
else if(!d.onClose){d.onClose=arguments[i];}}
else if(typeof(arguments[i])==='object'){d.options=arguments[i];}}
if(!d.height){d.height=false;}}
else{d=obj;}
if(d){if(!d.uid){d.uid='bbn-popup-'+bbn.fn.timestamp().toString()+'-'+bbn.fn.randomString(4,6);}
d.index=this.items.length;this.items.push(d);return d.uid;}
else{new Error("You must give a title and either a content or a component to a popup")}
return false;},load(obj){let d={};if(typeof(obj)!=='object'){for(let i=0;i<arguments.length;i++){if(!d.url&&(typeof(arguments[i])==='string')){d.url=arguments[i];}
else if(bbn.fn.isDimension(arguments[i])||(arguments[i]==='auto')){if(!d.width){d.width=arguments[i];}
else if(!d.height){d.height=arguments[i];}}
else if(bbn.fn.isFunction(arguments[i])){if(!d.onOpen){d.onOpen=arguments[i];}
else if(!d.close){d.onClose=arguments[i];}}
else if(typeof(arguments[i])==='object'){if(!d.data){d.data=arguments[i];}
else if(!d.options){d.options=arguments[i];}}}
if(!d.height){d.height=false;}}
else{d=obj;}
if(d.url){return this.post(d.url,d.data||{},r=>{if(r.content||r.title){if(r.script){let tmp=eval(r.script);delete r.script;if(bbn.fn.isFunction(tmp)){d.open=tmp;}
else if(typeof(tmp)==='object'){bbn.fn.extendOut(tmp,{name:bbn.fn.randomString(20,15).toLowerCase(),template:'<div class="bbn-overlay">'+(r.content||'')+'</div>',props:['source']});this.$options.components[tmp.name]=tmp;d.component=this.$options.components[tmp.name];d.source=r.data||[];}}
bbn.fn.extend(d,r);delete d.url;delete d.data;if(!d.uid){d.uid='bbn-popup-'+bbn.fn.timestamp().toString();}
d.index=this.items.length;bbn.fn.log("WIN",d);this.items.push(d);this.makeWindows();}})}
else{new Error("You must give a URL in order to load a popup")}},onClose(index){this.items.splice(index,1);},getObject(a){if(!a.uid){a.uid='bbn-popup-'+bbn.fn.timestamp().toString()}
if(a.closable===undefined){a.closable=true;}
if((a.title===undefined)&&this.untitled){a.title=this.untitled;}
return a;},loading(){return this.open({title:false,content:`
<div class="bbn-middle" style="width: 500px; height: 250px">
  <div class="bbn-block bbn-c bbn-b bbn-xl">`+bbn._('Loading')+`...</div>
</div>`,width:500,height:250,scrollable:false})},close(idx,force){if(idx===undefined){idx=this.items.length-1;}
let win=this.getWindow(idx);if(this.items[idx]&&win){win.close(force);this.$forceUpdate();}},getIndexByUID(uid){return bbn.fn.search(this.items,{uid:uid});},alert(){let has_msg=false,has_title=false,has_width=false,has_callback=false,okText,onOpen,onClose,i,o={};for(i=0;i<arguments.length;i++){if(!has_msg&&(typeof(arguments[i])==='string')){o.content=arguments[i];has_msg=1;}
else if(bbn.fn.isDimension(arguments[i])||(arguments[i]==='auto')){if(has_width){o.height=arguments[i];}
else{o.width=arguments[i];has_width=1;}}
else if(!has_title&&(typeof arguments[i]==='string')){o.title=arguments[i];has_title=true;}
else if(typeof arguments[i]==='string'){okText=arguments[i];}
else if(bbn.fn.isFunction(arguments[i])){if(has_callback){onClose=arguments[i];}
else{onOpen=arguments[i];has_callback=1;}}
else if(bbn.fn.isObject(arguments[i])){bbn.fn.extend(o,arguments[i]);}}
if(typeof(o)==='object'){if(o.closable===undefined){o.closable=true;}
if(!o.content){o.content=this.alertMessage;}
if(!o.title){o.title=false;}
if(!okText){okText=this.okText;}
o.content='<div class="'+(this.isMobile||this.isTablet?'bbn-padded':'bbn-lpadded')+' bbn-large bbn-c" style="min-width: '+(this.isMobile||this.isTablet?'15':'30')+'em">'+o.content+'</div>';o.buttons=[{text:okText,cls:'bbn-primary',icon:'nf nf-fa-check_circle',action($ev,btn){if(onClose){onClose($ev,btn);}
btn.closest('bbn-floater').close(true);}}];this.open(bbn.fn.extend(o,{maximizable:false,scrollable:true,resizable:false}));}},confirm(){let onYes=false,onNo=false,yesText=bbn._('Yes'),noText=bbn._('No'),o={},options={},has_msg=false,has_yes=false,has_width=false,i;if(bbn.fn.isObject(arguments[0])){o=arguments[0];}
else{for(i=0;i<arguments.length;i++){if(!has_msg&&(typeof(arguments[i])==='string')){o.content=arguments[i];has_msg=1;}
else if(bbn.fn.isDimension(arguments[i])||(arguments[i]==='auto')){if(has_width){o.height=arguments[i];}
else{o.width=arguments[i];has_width=1;}}
else if((typeof arguments[i]==='string')){if(!has_yes){yesText=arguments[i];has_yes=true;}
else{noText=arguments[i];}}
else if(bbn.fn.isFunction(arguments[i])){if(onYes){onNo=arguments[i];}
else{onYes=arguments[i];}}
else if(typeof(arguments[i])==='object'){options=arguments[i];}}}
if((typeof(o)==='object')&&onYes){if(!o.content){o.content=this.confirmMessage;}
if(!o.title){o.title=false;}
o.content='<div class="'+(this.isMobile||this.isTablet?'bbn-padded':'bbn-lpadded')+' bbn-large bbn-c" style="min-width: '+(this.isMobile||this.isTablet?'15':'30')+'em">'+o.content+'</div>';o.buttons=[{text:yesText,cls:'bbn-primary',icon:'nf nf-fa-check_circle',action($ev,btn){btn.closest('bbn-floater').close(true);setTimeout(()=>{onYes($ev,btn);},0);}},{text:noText,icon:'nf nf-fa-times_circle',action($ev,btn){btn.closest('bbn-floater').close(true);if(onNo){setTimeout(()=>{onNo($ev,btn);},0);}}}];this.open(bbn.fn.extend(o,options,{resizable:false,maximizable:false,scrollable:true}));}},makeWindows(){this.$forceUpdate();},getWindow(idx){if(this.popups.length){if(idx===undefined){idx=this.popups.length-1;}
if(this.popups[idx]){return bbn.vue.getChildByKey(this,this.popups[idx].uid);}}
return false;}},created(){this.componentClass.push('bbn-resize-emitter');},mounted(){bbn.fn.each(this.popups,a=>this.open(a));},watch:{items(){this.makeWindows();},numPopups(v){if(v&&!this.ready){this.ready=true;}}}});})(bbn);})(bbn);